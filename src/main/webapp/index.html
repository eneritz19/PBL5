<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkinXpert</title>
    <link rel="stylesheet" href="styles.css?v=2">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>

    <div id="splash-screen">
        <video id="splashVideo" autoplay muted loop playsinline>
            <source src="video_de_introduccion.mp4" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="splash-bouncer-container hidden">
            <img src="logopequeño.png" alt="Loading..." class="splash-bouncer">
        </div>
    </div>

    <div id="loginPage" class="container reveal-on-scroll" style="max-width: 450px; text-align: center;">

        <div style="margin-bottom: 20px;">
            <img src="logo_pequeño2.png" alt="Logo SkinXpert" style="width: 80px; height: auto;">
        </div>
        <h2 style="margin-top: 0;">Skin<span class="brand-x">X</span>pert</h2>
        <p style="font-size: 19px; margin-bottom: 30px;">Log in to continue.</p>

        <input id="email" type="text" placeholder="Email address or ID card">
        <input id="password" type="password" placeholder="Password">

        <button onclick="handleLogin()">Login</button>
    </div>


    <div id="patientDashboard" class="container hidden">
        <div class="header-flex">
            <div>
                <h2 style="font-size: 32px;">Hello, <span id="p_name">Patient</span></h2>
                <span class="role-badge">Patient</span>
            </div>
            <button class="btn-secondary" style="width: auto; margin:0;" onclick="logout()">Logout</button>
        </div>

        <div class="tabs reveal-on-scroll">
            <button class="tab-btn active" onclick="openTab('p-consult', this)">Inquiry</button>
            <button class="tab-btn" onclick="openTab('p-citas', this)">Appointments</button>
            <button class="tab-btn" onclick="openTab('p-historial', this)">History</button>
        </div>

        <div id="p-consult" class="tab-content active">
            <div class="case-card reveal-on-scroll" style="text-align: center; padding: 50px;">

                <i class="fa-solid fa-camera" style="font-size: 50px; color: #d2d2d7; margin-bottom: 20px;"></i>

                <h3>New Inquiry</h3>

                <p>Upload a photo of your injury so your doctor can evaluate it.</p>
                <div id="uploadMessage" style="
                    display:none;
                    margin:15px 0;
                    padding:12px;
                    border-radius:8px;
                    font-size:14px;
                    font-weight:600;
                ">
                </div>

                <img id="imagePreview" style="
                    display:none;
                    margin:20px auto;
                    max-width:100%;
                    max-height:300px;
                    border-radius:12px;
                    box-shadow:0 10px 25px rgba(0,0,0,0.15);
                " />

                <input type="file" id="uploadImage" accept="image/*" capture="environment"
                    onchange="previewImage(event)" style="margin-top:15px;">

                <button style="margin-top:20px;" onclick="uploadCase()">Send Inquiry</button>

            </div>

        </div>



        <div id="p-citas" class="tab-content">
            <div class="case-card reveal-on-scroll urgency-medium">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h4 style="margin:0;">Annual Review</h4>
                        <p style="margin:5px 0 0 0; color:var(--text-secondary);">Assigned Doctor</p>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-weight:bold; color:var(--sk-blue-dark);">15 DIC</span><br>
                        <span style="font-size:14px;">10:00 AM</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="p-historial" class="tab-content">
            <div id="patientHistoryList"></div>
        </div>
    </div>

    <div id="adminDashboard" class="container hidden" style="max-width:1000px;">
        <div class="header-flex">
            <h2>Admin Panel</h2>
            <button class="btn-secondary" onclick="logout()">Exit</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('admin-doctors', this)">Doctors</button>
            <button class="tab-btn" onclick="openTab('admin-patients', this)">Patients</button>
        </div>

        <div id="admin-doctors" class="tab-content active">
            <div id="adminDoctorsList"></div>
            <button class="btn-primary" onclick="openNewDoctor(); scrollToBottom();">
                New
            </button>


        </div>

        <div id="admin-patients" class="tab-content">
            <div id="adminPatientsList"></div>
            <button class="btn-primary" onclick="openNewPatient(); scrollToBottom();">
                New
            </button>

        </div>



    </div>


    <div id="doctorDashboard" class="container hidden" style="max-width: 900px;">
        <div class="header-flex">
            <div>
                <h2 style="font-size: 32px;"><span id="d_name">Doctor</span></h2>
                <span class="role-badge">Dermatology</span>
            </div>
            <button class="btn-secondary" style="width: auto; margin:0;" onclick="logout()">Exit</button>
        </div>

        <div class="tabs reveal-on-scroll">
            <button class="tab-btn active" onclick="openTab('d-pending', this)">Pending</button>
            <button class="tab-btn" onclick="openTab('d-patients', this)">Patients</button>
            <button class="tab-btn" onclick="openTab('d-citas', this)">Agenda</button>
            <button class="tab-btn" onclick="openTab('d-camera', this)">Camera</button>
        </div>

        <div id="d-pending" class="tab-content active">
            <p class="reveal-on-scroll" style="font-size:14px; color:var(--text-secondary); margin-bottom:20px;">
                <i class="fa-solid fa-arrow-down-short-wide"></i> Ordered by Urgency (IA)
            </p>
            <div id="doctorPendingList"></div>
        </div>

        <div id="d-patients" class="tab-content">
            <div class="case-card reveal-on-scroll"
                style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <strong></strong><br>
                    <span style="font-size:14px; color:#888;">ID: 001 • Last visit: Oct 2023</span>
                </div>
            </div>
        </div>

        <div id="d-citas" class="tab-content">
            <div class="case-card reveal-on-scroll">
                <h3 style="margin-bottom:20px;">Schedule an Appointment</h3>
                <input type="text" placeholder="Looking for a patient...">
                <input type="datetime-local">
                <button onclick="alert('Appointment saved in database')">Confirm Appointment</button>
            </div>
        </div>

        <div id="d-camera" class="tab-content">
            <div class="case-card reveal-on-scroll" style="background:#000; color:white; text-align:center;">
                <h3 style="color:white; margin-bottom:10px;">Dermatoscope Viewer</h3>
                <video id="camera-preview" autoplay playsinline
                    style="width:100%; border-radius:12px; background:#333; display:none;"></video>
                <div style="padding-top:20px;">
                    <button id="btnCamera" class="btn-secondary" onclick="toggleCamera()"
                        style="background:white !important; color:black !important; width:auto;">
                        <i class="fa-solid fa-camera"></i> Start
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        const API = "http://localhost:1880";

        // --- 1. ANIMACIÓN SCROLL ---
        const observerOptions = { root: null, rootMargin: '0px', threshold: 0.1 };
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        function scrollToBottom() {
            setTimeout(() => {
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: "smooth"
                });
            }, 150);
        }

        function initScrollAnimations() {
            const elements = document.querySelectorAll('.case-card, .container, .tabs, .reveal-on-scroll');
            elements.forEach(el => observer.observe(el));
        }

        // --- 2. LOGICA SPLASH SCREEN (VIDEO) ---
        window.addEventListener('load', () => {
            const splash = document.getElementById('splash-screen');
            const video = document.getElementById('splashVideo'); // Obtenemos la referencia al video

            if (video) {
                // Intenta forzar la reproducción (necesario en algunos entornos)
                video.play().catch(e => console.log("Error al reproducir video", e));
            }

            // Usaremos el mismo temporizador de 3.5 segundos para la transición de salida
            // Simular tiempo de carga de 3.5 segundos
            const SPLASH_DURATION = 3500;

            setTimeout(() => {
                splash.classList.add('hidden-splash'); // Iniciar transición de salida

                // Detener la reproducción del video para ahorrar recursos
                if (video) {
                    video.pause();
                    video.currentTime = 0; // Reiniciar
                }

                // Esperar a que termine la transición CSS (0.8s) antes de ocultar
                setTimeout(() => {
                    splash.style.display = 'none';
                    initScrollAnimations(); // Animar entrada del login
                }, 800);

            }, SPLASH_DURATION); // Tiempo total de "carga"
        });

        async function sendDiagnosis(reqId, docId, patId) {
            // 1. Recuperar valores de los inputs específicos de ESTA tarjeta
            const diseaseSelect = document.getElementById(`disease-${reqId}`);
            const notesInput = document.getElementById(`notes-${reqId}`);
            const appointmentInput = document.getElementById(`appointment-${reqId}`);

            const diseaseId = diseaseSelect.value;
            const notes = notesInput.value;

            if (!notes) {
                alert("Please write some notes for the patient.");
                return;
            }

            const payload = {
                id_request: reqId,
                id_doctor: docId,
                id_patient: patId, // Asegúrate que tu SELECT de pending devuelva esto
                id_skindiseases: parseInt(diseaseId),
                confidence: 100,
                doctor_notes: notes,
                appointment_date: appointmentInput.value
            };

            try {
                const res = await fetch(`${API}/doctor/send_report`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();

                if (res.ok) {
                    alert("Report sent successfully");
                    loadDoctorPending(); // Recargar la lista para que desaparezca
                    loadDoctorAppointments();
                } else {
                    alert("Error: " + JSON.stringify(result));
                }
            } catch (e) {
                console.error(e);
                alert("Connection error while sending report.");
            }
        }
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function showUploadMessage(text, success = true) {
            const msg = document.getElementById("uploadMessage");
            msg.innerText = text;
            msg.style.display = "block";
            msg.style.background = success ? "#e6fffa" : "#ffe6e6";
            msg.style.color = success ? "#065f46" : "#991b1b";
            msg.style.border = success
                ? "1px solid #34d399"
                : "1px solid #f87171";
        }


        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById("imagePreview");

            if (!file) {
                preview.style.display = "none";
                return;
            }

            const reader = new FileReader();
            reader.onload = () => {
                preview.src = reader.result;
                preview.style.display = "block";
            };
            reader.readAsDataURL(file);
        }
        function openAdminForm(isEdit = false) {
            document.getElementById("adminFormContainer").classList.remove("hidden");

            const saveBtn = document.getElementById("adminFormSaveBtn");
            if (isEdit) {
                saveBtn.onclick = submitFormEdit;
            } else {
                saveBtn.onclick = submitForm;
            }
        }

        //ADMINISTRADOR
        async function editDoctor(id_doctor) {
            try {
                const res = await fetch(`${API}/admin/doctor/${id_doctor}`);
                if (!res.ok) throw new Error("Doctor not found");

                const doctor = await res.json();

                document.getElementById("modal-title").innerText = "Edit Doctor";
                document.getElementById("modal-body").innerHTML = `
            <input type="hidden" id="edit_doctor_id" value="${doctor.id_doctor}">
            <div style="margin:20px 100px;">
                <input id="edit_doctor_code" placeholder="Doctor Code" value="${doctor.doctor_code}">
                <input id="edit_doctor_name" placeholder="Full Name" value="${doctor.name}">
                <input id="edit_doctor_email" placeholder="Email address" value="${doctor.email}">
                <input id="edit_doctor_password" type="password" placeholder="Temporary Password (leave blank to keep current)">
                <input id="edit_doctor_clinic" placeholder="Clinic ID (optional)" value="${doctor.id_clinic || ''}">
            </div>
        `;

                currentType = "doctor";
                isEditing = true; // ✅ importante
                openModal("doctor", true);
                scrollToBottom();
            } catch (err) {
                console.error(err);
                alert("Error fetching doctor data");
            }
        }

        async function editPatient(id_patient) {
            try {
                const res = await fetch(`${API}/admin/patient/${id_patient}`);
                if (!res.ok) throw new Error("Patient not found");

                const patient = await res.json();

                document.getElementById("modal-title").innerText = "Edit Patient";
                document.getElementById("modal-body").innerHTML = `
            <input type="hidden" id="edit_patient_id" value="${patient.id_patient}">
            <div style="margin:20px 100px;">
                <input id="edit_patient_dni" placeholder="DNI / ID" value="${patient.dni}">
                <input id="edit_patient_name" placeholder="Full Name" value="${patient.name}">
                <input id="edit_patient_email" placeholder="Email address" value="${patient.email}">
                <input id="edit_patient_password" type="password" placeholder="Temporary Password (leave blank to keep current)">
                <select id="edit_patient_doctor">
                    <option value="">No assigned doctor</option>
                </select>
            </div>
        `;

                // Cargar lista de doctores en el select
                const doctorRes = await fetch(`${API}/admin/doctors`);
                const doctors = await doctorRes.json();
                const select = document.getElementById("edit_patient_doctor");
                doctors.forEach(d => {
                    const option = document.createElement("option");
                    option.value = d.id_doctor;
                    option.textContent = `${d.name} (${d.email})`;
                    if (d.id_doctor === patient.id_doctor) option.selected = true;
                    select.appendChild(option);
                });

                currentType = "patient";
                isEditing = true; // ✅ importante
                openModal("patient", true);
                scrollToBottom();

            } catch (err) {
                console.error(err);
                alert("Error fetching patient data");
            }
        }

        async function submitFormEdit() {
            let payload = {};
            let endpoint = "";
            let method = "PUT"; // edición

            if (currentType === "doctor") {
                const idDoctor = document.getElementById("edit_doctor_id").value; // el ID real
                if (!idDoctor) return alert("No se encontró el ID del doctor.");

                payload = {
                    name: document.getElementById("edit_doctor_name").value,
                    email: document.getElementById("edit_doctor_email").value,
                    id_clinic: document.getElementById("edit_doctor_clinic").value || null
                };

                const password = document.getElementById("edit_doctor_password").value;
                if (password) payload.password = password; // solo si cambió

                endpoint = `${API}/admin/doctor/${idDoctor}`; // Node-RED PUT endpoint

            } else if (currentType === "patient") {
                const idPatient = document.getElementById("edit_patient_id").value; // el ID real
                if (!idPatient) return alert("No se encontró el ID del paciente.");

                payload = {
                    name: document.getElementById("edit_patient_name").value,
                    email: document.getElementById("edit_patient_email").value,
                    dni: document.getElementById("edit_patient_dni").value,
                    id_doctor: document.getElementById("edit_patient_doctor").value || null
                };

                const password = document.getElementById("edit_patient_password").value;
                if (password) payload.password = password;

                endpoint = `${API}/admin/patient/${idPatient}`; // Node-RED PUT endpoint
            }

            try {
                const res = await fetch(endpoint, {
                    method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok) {
                    alert(`${currentType === "doctor" ? "Doctor" : "Paciente"} actualizado correctamente!`);
                    closeModal();
                    loadAdminDoctors();
                    loadAdminPatients();
                } else {
                    alert("Error al actualizar: " + JSON.stringify(data));
                }

            } catch (err) {
                console.error(err);
                alert("Error de conexión con el servidor.");
            }
        }



        async function loadAdminDoctors() {
            const res = await fetch(`${API}/admin/doctors`);
            const doctors = await res.json();

            const list = document.getElementById("adminDoctorsList");
            list.innerHTML = "";

            doctors.forEach(d => {
                list.innerHTML += `
        <div class="case-card" style="display:flex;justify-content:space-between;">
            <div>
                <strong>${d.name}</strong><br>
                <span style="color:#888">${d.email} • ${d.clinic || ''}</span>
            </div>
            <div>
                <button class="btn-secondary" style="color:red;"
                        onclick="editDoctor(${d.id_doctor})">
                    Edit
                </button>

                <button class="btn-secondary" style="color:red;"
                        onclick="deleteDoctor(${d.id_doctor})">
                    Delete
                </button>   
            </div>
        </div>`;
            });
        }

        async function loadAdminPatients() {
            const res = await fetch(`${API}/admin/patients`);
            const patients = await res.json();

            const list = document.getElementById("adminPatientsList");
            list.innerHTML = "";

            patients.forEach(p => {
                list.innerHTML += `
        <div class="case-card" style="display:flex;justify-content:space-between;">
            <div>
                <strong>${p.name}</strong><br>
                <span style="color:#888">${p.email} • Doctor: ${p.doctor || '—'}</span>
            </div>
            <div>
                <button class="btn-secondary" style="color:red;" onclick="editPatient(${p.id_patient})">
                    Edit
                </button>

                <button class="btn-secondary" style="color:red;"
                        onclick="deletePatient(${p.id_patient})">
                    Delete
                </button>
            </div>
        </div>`;
            });
        }
        async function deleteDoctor(id) {
            if (!confirm("Are you sure you want to delete this doctor and ALL related data?")) return;

            const res = await fetch(`${API}/admin/doctor/${id}`, {
                method: "DELETE"
            });

            const data = await res.json();

            if (res.ok) {
                alert("Doctor deleted successfully");
                loadAdminDoctors();
                loadAdminPatients(); // por si había pacientes asignados
            } else {
                alert("Error deleting doctor");
            }
        }

        async function deletePatient(id) {
            if (!confirm("Are you sure you want to delete this patient and ALL related data?")) return;

            const res = await fetch(`${API}/admin/patient/${id}`, {
                method: "DELETE"
            });

            const data = await res.json();

            if (res.ok) {
                alert("Patient deleted successfully");
                loadAdminPatients();
            } else {
                alert("Error deleting patient");
            }
        }
        function openNewDoctor() {

            document.getElementById("modal-title").innerText = "New Doctor";

            document.getElementById("modal-body").innerHTML = `
        <div style="margin:20px 100px;">
            <input id="new_doctor_code" placeholder="Doctor Code">
            <input id="new_doctor_name" placeholder="Full Name">
            <input id="new_doctor_email" placeholder="Email address">
            <input id="new_doctor_password" type="password" placeholder="Temporary Password">
            <input id="new_doctor_clinic" placeholder="Clinic ID (optional)">
        </div>
    `;

            openModal("doctor", false);
        }


        function openNewPatient() {
            document.getElementById("modal-title").innerText = "New Patient";

            document.getElementById("modal-body").innerHTML = `
        <div style="margin:20px 100px;">
            <input id="new_patient_dni" placeholder="DNI / ID">
            <input id="new_patient_name" placeholder="Full Name">
            <input id="new_patient_email" placeholder="Email address">
            <input id="new_patient_password" type="password" placeholder="Temporary Password">
            <select id="new_patient_doctor">
                <option value="">No assigned doctor</option>
            </select>
        </div>
    `;

            openModal("patient", false); // <- aquí decimos que NO es edición
            loadDoctorsForSelect();
        }




        async function loadDoctorsForSelect() {
            try {
                const res = await fetch(`${API}/admin/doctors`);
                const doctors = await res.json();

                const select = document.getElementById("new_patient_doctor");
                if (!select) return;

                doctors.forEach(d => {
                    const option = document.createElement("option");
                    option.value = d.id_doctor;
                    option.textContent = `${d.name} (${d.email})`;
                    select.appendChild(option);
                });

            } catch (err) {
                console.error(err);
                alert("Error loading doctors");
            }
        }



        let currentType = null;  // "doctor" o "patient"
        let isEditing = false;   // true si estamos editando, false si creamos

        // Abrir modal (creación o edición)
        function openModal(type, editing = false) {
            currentType = type;
            isEditing = editing;

            const modal = document.getElementById("modal");
            modal.classList.remove("hidden");
        }

        // Cerrar modal
        function closeModal() {
            document.getElementById("modal").classList.add("hidden");
        }

        // Función central del botón Save
        function modalSave() {
            if (isEditing) {
                submitFormEdit();
            } else {
                submitForm();
            }
        }


        async function submitForm() {
            let payload = {};

            if (currentType === "doctor") {
                payload = {
                    doctor_code: document.getElementById("new_doctor_code").value,
                    name: document.getElementById("new_doctor_name").value,
                    email: document.getElementById("new_doctor_email").value,
                    password: document.getElementById("new_doctor_password").value,
                    id_clinic: document.getElementById("new_doctor_clinic").value || null
                };

                try {
                    const res = await fetch("http://localhost:1880/admin/new/doctor", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();

                    if (res.ok) {
                        alert("Doctor created successfully!");
                        closeModal();
                        loadAdminDoctors();
                    } else {
                        alert("Error creating doctor: " + JSON.stringify(data));
                    }
                } catch (err) {
                    console.error(err);
                    alert("Server connection error.");
                }

            } else if (currentType === "patient") {
                payload = {
                    dni: document.getElementById("new_patient_dni").value,
                    name: document.getElementById("new_patient_name").value,
                    email: document.getElementById("new_patient_email").value,
                    password: document.getElementById("new_patient_password").value,
                    id_doctor: document.getElementById("new_patient_doctor").value || null
                };

                try {
                    const res = await fetch("http://localhost:1880/admin/new/patient", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();

                    if (res.ok) {
                        alert("Patient created successfully!");
                        closeModal();
                        loadAdminPatients();
                    } else {
                        alert("Error creating patient: " + JSON.stringify(data));
                    }
                } catch (err) {
                    console.error(err);
                    alert("Server connection error.");
                }
            }
        }


        // FIN ADMINISTRADOR

        async function uploadCase() {
            const fileInput = document.getElementById("uploadImage");
            const file = fileInput.files[0];
            const patientId = localStorage.getItem("patient_id");

            if (!file) {
                showUploadMessage("Please select a photo first.", false);
                return;
            }

            try {
                const base64 = await getBase64(file);

                const payload = {
                    id_patient: patientId,
                    urgency: Math.floor(Math.random() * 100),
                    image_base64: base64,
                    file_name: file.name
                };

                const res = await fetch(`${API}/patient/upload_photo`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok) {
                    showUploadMessage("Photo uploaded successfully!");

                    fileInput.value = "";
                    const preview = document.getElementById("imagePreview");
                    preview.style.display = "none";
                    preview.src = "";

                    loadPatientHistory();
                } else {
                    showUploadMessage("Error uploading the photo.", false);
                }


            } catch (error) {
                console.error(error);
                showUploadMessage("Connection error.", false);
            }
        }



        // --- 3. LOGIN ---
        async function handleLogin() {
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value.trim();

            if (!email || !password) return alert("Please fill in all fields.");

            try {
                const res = await fetch(`${API}/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();

                if (!data.success) {
                    alert("Incorrect username or password.");
                    return;
                }

                document.getElementById("loginPage").classList.add("hidden");

                const role = data.role.toLowerCase();

                if (role === "patient" || role === "patients") {
                    document.getElementById("patientDashboard").classList.remove("hidden");
                    document.getElementById("p_name").innerText = data.user.name;

                    localStorage.setItem("patient_id", data.user.id);
                    localStorage.setItem("token", data.token);

                    loadPatientHistory();
                    loadPatientAppointments();

                } else if (role === "doctor" || role === "doctors") {
                    document.getElementById("doctorDashboard").classList.remove("hidden");
                    document.getElementById("d_name").innerText = data.user.name;
                    localStorage.setItem("doctor_id", data.user.id);
                    localStorage.setItem("token", data.token);
                    loadDoctorPatients();
                    loadDoctorPending();
                    loadDoctorAppointments();

                } else if (role === "admin") {
                    document.getElementById("adminDashboard").classList.remove("hidden");
                    loadAdminDoctors();
                    loadAdminPatients();

                }

                setTimeout(initScrollAnimations, 100);

            } catch (error) {
                console.error(error);
                alert("Server connection error.");
            }
        }

        function logout() { location.reload(); }

        // --- 4. INTERFAZ ---
        function openTab(tabId, btn) {
            const parent = btn.closest('.container');
            parent.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            parent.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            parent.querySelector(`#${tabId}`).classList.add('active');
            btn.classList.add('active');
            setTimeout(initScrollAnimations, 50);
        }


        let stream = null;
        async function toggleCamera() {
            const video = document.getElementById('camera-preview');
            const btn = document.getElementById('btnCamera');

            if (video.style.display === 'none') {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    video.srcObject = stream;
                    video.style.display = 'block';
                    btn.innerText = "Detener";
                    btn.style.color = "red";
                } catch (e) { alert("Camera not available"); }
            } else {
                if (stream) stream.getTracks().forEach(t => t.stop());
                video.style.display = 'none';
                btn.innerText = "Iniciar";
                btn.style.color = "black";
            }
        }

        // --- 5. DATOS PACIENTES---
        async function loadPatientHistory() {
            const patientId = localStorage.getItem("patient_id");

            try {
                const res = await fetch(`${API}/patient/history?id_patient=${patientId}`);
                const history = await res.json();

                const list = document.getElementById("patientHistoryList");
                list.innerHTML = "";

                if (!history.length) {
                    list.innerHTML = `<p style="color:#888;">Sin historial aún.</p>`;
                    return;
                }

                history.forEach(h => {
                    const fecha = new Date(h.diagnosis_date).toLocaleDateString("es-ES");

                    list.innerHTML += `
            <div class="case-card reveal-on-scroll urgency-low">
                <p style="font-size:14px; color:#888;">${fecha}</p>
                <div style="display:flex; gap:15px; margin-top:10px;">
                    <img src="${h.file_path || 'https://via.placeholder.com/100'}"
                         style="width:80px; height:80px; border-radius:8px;">
                    <div>
                        <strong>${h.disease}</strong>
                        <p style="margin-top:5px; font-size:14px;">
                            ${h.doctor_notes || ''}
                        </p>
                    </div>
                </div>
            </div>`;
                });

                initScrollAnimations();

            } catch (err) {
                console.error(err);
                alert("Error loading history");
            }
        }

        async function loadPatientAppointments() {
    const patientId = localStorage.getItem("patient_id");

    try {
        const res = await fetch(`${API}/patient/appointments?id_patient=${patientId}`);
        const citas = await res.json();

        const list = document.getElementById("p-citas");
        list.innerHTML = "";

        if (!Array.isArray(citas) || citas.length === 0) {
            list.innerHTML = `
                <div class="case-card reveal-on-scroll">
                    <p style="color:#888;">No tienes citas.</p>
                </div>`;
            return;
        }

        citas.forEach(c => {
            if (!c.date) return;

            const fecha = new Date(c.date);
            if (isNaN(fecha)) return;

            const dia = fecha.getDate().toString().padStart(2, '0');
            const mes = fecha.toLocaleString('es-ES', { month: 'short' }).toUpperCase();
            const hora = fecha.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit'
            });

            list.innerHTML += `
                <div class="case-card reveal-on-scroll urgency-medium">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h4 style="margin:0;">Cita con ${c.doctor_name}</h4>
                            <p style="margin:5px 0 0 0; color:var(--text-secondary);">
                                Status: ${c.status}
                            </p>
                        </div>
                        <div style="text-align:right;">
                            <span style="font-weight:bold; color:var(--sk-blue-dark);">${dia} ${mes}</span><br>
                            <span style="font-size:14px;">${hora}</span>
                        </div>
                    </div>
                </div>`;
        });

        initScrollAnimations();

    } catch (err) {
        console.error(err);
        alert("Error loading appointments");
    }
}




        // CARGA DE CASOS DOCTOR
        async function loadDoctorPatients() {
            const doctorId = localStorage.getItem("doctor_id");

            try {
                const res = await fetch(`${API}/doctor/patients?id_doctor=${doctorId}`);
                const patients = await res.json();

                const list = document.getElementById("d-patients");
                list.innerHTML = "";

                patients.forEach(p => {
                    list.innerHTML += `
                <div class="case-card reveal-on-scroll"
                    style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${p.name}</strong><br>
                        <span style="font-size:14px; color:#888;">
                            ID: ${p.dni} • ${p.email}
                        </span>
                    </div>
                </div>
            `;
                });

                initScrollAnimations();

            } catch (err) {
                console.error(err);
                alert("Error loading patients");
            }
        }


        async function loadDoctorPending() {
            const doctorId = localStorage.getItem("doctor_id");

            const res = await fetch(`${API}/doctor/pending?id_doctor=${doctorId}`);
            const cases = await res.json();

            const list = document.getElementById("doctorPendingList");
            list.innerHTML = "";

            if (cases.length === 0) {
                list.innerHTML = "<p>There are no pending patients.</p>";
                return;
            }

            cases.forEach(c => {
                let badgeClass = 'badge-low';
                let cardClass = 'urgency-low';

                if (c.urgency > 80) { badgeClass = 'badge-high'; cardClass = 'urgency-high'; }
                else if (c.urgency > 40) { badgeClass = 'badge-medium'; cardClass = 'urgency-medium'; }

                list.innerHTML += `
        <div class="case-card reveal-on-scroll ${cardClass}">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>${c.name}</h3>
                <span class="urgency-badge ${badgeClass}">${c.urgency}% URGENCY</span>
            </div>
            
            <img src="${API}${c.file_path}" style="height:120px; object-fit:cover; margin: 10px 0; border-radius:8px;">
            
            <label style="font-size:12px; font-weight:bold;">Diagnostic (ilness):</label>
            <select id="disease-${c.id_request}" style="width:100%; padding:8px; margin-bottom:10px;">
                <option value="1">Acne and Rosacea</option>
                <option value="2">Actinic keratosis</option>
                <option value="3">Atopic dermatitis</option>
                <option value="15">Psoriasis</option>
                <option value="16">Scabies / Lyme</option>
                <option value="20">Urticaria</option>
            </select>

            <label style="font-size:12px; font-weight:bold;">Schedule an Appointment (Optional):</label>
            <input type="datetime-local" id="appointment-${c.id_request}" 
                   style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ddd; border-radius:4px;">

            <textarea id="notes-${c.id_request}" placeholder="Write the treatment or notes..." rows="3" style="width:100%;"></textarea>
            
            <button onclick="sendDiagnosis(${c.id_request}, ${doctorId}, ${c.id_patient})">Send Report</button>
        </div>
    `;
            });

            initScrollAnimations();
        }
        async function loadDoctorAppointments() {
            const doctorId = localStorage.getItem("doctor_id");

            try {
                const res = await fetch(`${API}/doctor/appointments?id_doctor=${doctorId}`);
                const citas = await res.json();

                const list = document.getElementById("d-citas");
                list.innerHTML = "";

                if (!citas.length) {
                    list.innerHTML = `
                <div class="case-card reveal-on-scroll">
                    <p style="color:#888;">There are no scheduled appointments.</p>
                </div>`;
                    return;
                }

                citas.forEach(c => {
                    const fecha = new Date(c.date);
                    const dia = fecha.getDate().toString().padStart(2, '0');
                    const mes = fecha.toLocaleString('es-ES', { month: 'short' }).toUpperCase();
                    const hora = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

                    let estadoColor = "#999";
                    if (c.status === 'pending') estadoColor = "#d39e00";
                    if (c.status === 'done') estadoColor = "#28a745";
                    if (c.status === 'cancel') estadoColor = "#dc3545";

                    list.innerHTML += `
                <div class="case-card reveal-on-scroll" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${c.patient_name}</strong><br>
                        <span style="font-size:14px; color:#888;">Estado:
                            <b style="color:${estadoColor};">${c.status}</b>
                        </span><br>
                        <span style="font-size:14px;">${dia} ${mes} • ${hora}</span>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-secondary" onclick="editAppointment(${c.id_appointment}, '${c.date}', ${c.id_patient})">Edit</button>
                        <button class="btn-secondary" style="color:red;" onclick="deleteAppointment(${c.id_appointment}, ${c.id_patient})">Delete</button>
                    </div>
                </div>
            `;
                });

                initScrollAnimations();

            } catch (err) {
                console.error(err);
                alert("Error loading appointments.");
            }
        }
        async function editAppointment(id_appointment, currentDate, patientId) {
    // Pedimos la nueva fecha y hora
    const newDate = prompt("Select new date and time (YYYY-MM-DDTHH:MM):", currentDate.slice(0, 16));
    if (!newDate) return;

    try {
        // Llamada al endpoint Node-RED que actualiza la cita
        const res = await fetch(`${API}/appointment/${id_appointment}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ date: newDate })
        });

        if (res.ok) {
            alert("Appointment updated successfully!");
            // Recargar listas
            await loadDoctorAppointments();
            await loadPatientAppointments();
        } else {
            const data = await res.json();
            alert("Error updating appointment: " + JSON.stringify(data));
        }
    } catch (err) {
        console.error(err);
        alert("Connection error while updating appointment");
    }
}




async function deleteAppointment(id_appointment, patientId) {
    if (!confirm("Are you sure you want to delete this appointment and its diagnosis?")) return;

    try {
        const res = await fetch(`${API}/appointment/${id_appointment}`, {
            method: "DELETE"
        });

        if (!res.ok) {
            const data = await res.json();
            throw new Error(JSON.stringify(data));
        }

        // RECARGAR TODO
        await loadDoctorAppointments();
        await loadPatientAppointments();
        await loadPatientHistory();

        alert("Appointment deleted successfully!");

    } catch (err) {
        console.error(err);
        alert("Error deleting appointment");
    }
}



    </script>
    <!-- MODAL NEW DOCTOR / PATIENT -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <div id="modal-body"></div>

            <div class="modal-actions" style="margin: 15px 100px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" id="modalSaveBtn" onclick="modalSave()">Save</button>
            </div>
        </div>
    </div>





</body>

</html>