<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkinXpert - Detección Inteligente de Problemas de Piel</title>
    <link rel="stylesheet" href="styles.css">

</head>
<body>

    <!-- ANIMACIÓN DE CARGA DEL LOGO -->
    <div id="logoLoader">
        <div class="loader-logo-container">
            <svg fill="none" preserveAspectRatio="none" viewBox="0 0 512 512">
                <path
                    d="M256 448C362.039 448 448 362.039 448 256C448 149.961 362.039 64 256 64C149.961 64 64 149.961 64 256C64 362.039 149.961 448 256 448Z"
                    opacity="0.3" stroke="url(#paint0_linear)" stroke-width="25.6" />
                <path id="sonarArc"
                    d="M256 64C306.922 64 355.758 84.2285 391.765 120.235C427.772 156.242 448 205.078 448 256"
                    stroke="url(#paint1_linear)" stroke-linecap="round" stroke-width="34.1333" />
                <path d="M128 170.667V128H170.667" stroke="#0EA5E9" stroke-linecap="round" stroke-width="21.3333" />
                <path d="M384 170.667V128H341.333" stroke="#0EA5E9" stroke-linecap="round" stroke-width="21.3333" />
                <path d="M128 341.333V384H170.667" stroke="#38BDF8" stroke-linecap="round" stroke-width="21.3333" />
                <path d="M384 341.333V384H341.333" stroke="#38BDF8" stroke-linecap="round" stroke-width="21.3333" />
                <path
                    d="M256 375.467C321.98 375.467 375.467 321.98 375.467 256C375.467 190.02 321.98 136.533 256 136.533C190.02 136.533 136.533 190.02 136.533 256C136.533 321.98 190.02 375.467 256 375.467Z"
                    fill="url(#paint2_linear)" opacity="0.85" />
                <path
                    d="M256 307.2C284.277 307.2 307.2 284.277 307.2 256C307.2 227.723 284.277 204.8 256 204.8C227.723 204.8 204.8 227.723 204.8 256C204.8 284.277 227.723 307.2 256 307.2Z"
                    fill="white" />
                <path
                    d="M256 290.133C274.851 290.133 290.133 274.851 290.133 256C290.133 237.149 274.851 221.867 256 221.867C237.149 221.867 221.867 237.149 221.867 256C221.867 274.851 237.149 290.133 256 290.133Z"
                    fill="#0EA5E9" />
                <defs>
                    <linearGradient gradientUnits="userSpaceOnUse" id="paint0_linear" x1="64" x2="38464" y1="64"
                        y2="38464">
                        <stop stop-color="#0EA5E9" />
                        <stop offset="1" stop-color="#38BDF8" />
                    </linearGradient>
                    <linearGradient gradientUnits="userSpaceOnUse" id="paint1_linear" x1="256" x2="19456" y1="64"
                        y2="19264">
                        <stop stop-color="#0EA5E9" />
                        <stop offset="1" stop-color="#38BDF8" />
                    </linearGradient>
                    <linearGradient gradientUnits="userSpaceOnUse" id="paint2_linear" x1="136.533" x2="24029.9"
                        y1="136.533" y2="24029.9">
                        <stop stop-color="#38BDF8" />
                        <stop offset="0.5" stop-color="#0EA5E9" />
                        <stop offset="1" stop-color="#1C3555" />
                    </linearGradient>
                </defs>
            </svg>
        </div>
        <div class="loader-text">Skin<span class="brand-x">X</span>pert</div>
        <div class="loader-subtext">Cargando experiencia...</div>
    </div>

    <!-- LANDING PAGE -->
    <div id="landingPage" class="landing-page hidden">
        <!-- Navbar -->
        <nav class="landing-navbar">
            <div class="navbar-content">
                <div class="navbar-logo">
                    <svg fill="none" preserveAspectRatio="none" viewBox="0 0 512 512" width="40" height="40">
                        <g>
                            <path
                                d="M256 448C362.039 448 448 362.039 448 256C448 149.961 362.039 64 256 64C149.961 64 64 149.961 64 256C64 362.039 149.961 448 256 448Z"
                                opacity="0.3" stroke="url(#paint0_linear_nav)" stroke-width="25.6" />
                            <path
                                d="M256 64C306.922 64 355.758 84.2285 391.765 120.235C427.772 156.242 448 205.078 448 256"
                                stroke="url(#paint1_linear_nav)" stroke-linecap="round" stroke-width="34.1333" />
                            <path
                                d="M256 375.467C321.98 375.467 375.467 321.98 375.467 256C375.467 190.02 321.98 136.533 256 136.533C190.02 136.533 136.533 190.02 136.533 256C136.533 321.98 190.02 375.467 256 375.467Z"
                                fill="url(#paint2_linear_nav)" opacity="0.85" />
                            <path
                                d="M256 307.2C284.277 307.2 307.2 284.277 307.2 256C307.2 227.723 284.277 204.8 256 204.8C227.723 204.8 204.8 227.723 204.8 256C204.8 284.277 227.723 307.2 256 307.2Z"
                                fill="white" />
                            <path
                                d="M256 290.133C274.851 290.133 290.133 274.851 290.133 256C290.133 237.149 274.851 221.867 256 221.867C237.149 221.867 221.867 237.149 221.867 256C221.867 274.851 237.149 290.133 256 290.133Z"
                                fill="#0EA5E9" />
                            <path d="M128 170.667V128H170.667" stroke="#0EA5E9" stroke-linecap="round"
                                stroke-width="21.3333" />
                            <path d="M384 170.667V128H341.333" stroke="#0EA5E9" stroke-linecap="round"
                                stroke-width="21.3333" />
                            <path d="M128 341.333V384H170.667" stroke="#38BDF8" stroke-linecap="round"
                                stroke-width="21.3333" />
                            <path d="M384 341.333V384H341.333" stroke="#38BDF8" stroke-linecap="round"
                                stroke-width="21.3333" />
                        </g>
                        <defs>
                            <linearGradient gradientUnits="userSpaceOnUse" id="paint0_linear_nav" x1="64" x2="38464"
                                y1="64" y2="38464">
                                <stop stop-color="#0EA5E9" />
                                <stop offset="1" stop-color="#38BDF8" />
                            </linearGradient>
                            <linearGradient gradientUnits="userSpaceOnUse" id="paint1_linear_nav" x1="256" x2="19456"
                                y1="64" y2="19264">
                                <stop stop-color="#0EA5E9" />
                                <stop offset="1" stop-color="#38BDF8" />
                            </linearGradient>
                            <linearGradient gradientUnits="userSpaceOnUse" id="paint2_linear_nav" x1="136.533"
                                x2="24029.9" y1="136.533" y2="24029.9">
                                <stop stop-color="#38BDF8" />
                                <stop offset="0.5" stop-color="#0EA5E9" />
                                <stop offset="1" stop-color="#1C3555" />
                            </linearGradient>
                        </defs>
                    </svg>
                    <span>Skin<span class="brand-x">X</span>pert</span>
                </div>
                <div class="navbar-links">
                    <a href="#inicio">Inicio</a>
                    <a href="#caracteristicas">Características</a>
                    <a href="#como-funciona">Cómo Funciona</a>
                    <a href="#descargar">Descargar</a>
                    <button class="btn-login" onclick="showLogin()">Iniciar Sesión</button>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <section id="inicio" class="hero-section">
            <div class="hero-content">
                <div class="hero-text">
                    <div class="hero-badge animate-on-scroll">
                        <i class="fa-solid fa-check-circle"></i>
                        Tecnología médica avanzada
                    </div>
                    <h1 class="hero-title animate-on-scroll">Detección Temprana de Problemas de la Piel al Alcance de tu
                        Mano</h1>
                    <p class="hero-description animate-on-scroll">
                        SkinXpert utiliza inteligencia artificial avanzada para detectar cánceres de piel y otros
                        problemas dermatológicos.
                        Nuestra IA analiza, prioriza por urgencia y conecta pacientes con especialistas para
                        diagnósticos precisos.
                    </p>
                    <div class="hero-buttons animate-on-scroll">
                        <button class="btn-primary" onclick="showLogin()">
                            Comenzar Ahora
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                        <button class="btn-outline"
                            onclick="document.getElementById('descargar').scrollIntoView({behavior: 'smooth'})">
                            Descargar App
                            <i class="fa-solid fa-download"></i>
                        </button>
                    </div>
                    <div class="hero-features animate-on-scroll">
                        <div class="hero-feature">
                            <i class="fa-solid fa-check-circle" style="color: var(--sk-blue-light);"></i>
                            Análisis en segundos
                        </div>
                        <div class="hero-feature">
                            <i class="fa-solid fa-check-circle" style="color: var(--sk-blue-light);"></i>
                            Privacidad garantizada
                        </div>
                        <div class="hero-feature">
                            <i class="fa-solid fa-check-circle" style="color: var(--sk-blue-light);"></i>
                            Fácil de usar
                        </div>
                    </div>
                </div>
                <div class="hero-image animate-scale">
                    <div class="hero-phone-mockup">
                        <svg class="phone-frame" viewBox="0 0 300 600" fill="none">
                            <!-- Phone Frame -->
                            <rect x="10" y="10" width="280" height="580" rx="40" fill="#1d1d1f" />
                            <rect x="20" y="20" width="260" height="560" rx="35" fill="url(#screenGradient)" />
                            <!-- Notch -->
                            <rect x="100" y="20" width="100" height="25" rx="12" fill="#000" />

                            <defs>
                                <linearGradient id="screenGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#0EA5E9;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#38BDF8;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                        </svg>

                        <!-- Login Content dentro del móvil -->
                        <div class="phone-login-content">
                            <svg class="phone-login-logo" fill="none" viewBox="0 0 512 512">
                                <path
                                    d="M256 375.467C321.98 375.467 375.467 321.98 375.467 256C375.467 190.02 321.98 136.533 256 136.533C190.02 136.533 136.533 190.02 136.533 256C136.533 321.98 190.02 375.467 256 375.467Z"
                                    fill="url(#paint_phone)" opacity="0.85" />
                                <path
                                    d="M256 307.2C284.277 307.2 307.2 284.277 307.2 256C307.2 227.723 284.277 204.8 256 204.8C227.723 204.8 204.8 227.723 204.8 256C204.8 284.277 227.723 307.2 256 307.2Z"
                                    fill="white" />
                                <path
                                    d="M256 290.133C274.851 290.133 290.133 274.851 290.133 256C290.133 237.149 274.851 221.867 256 221.867C237.149 221.867 221.867 237.149 221.867 256C221.867 274.851 237.149 290.133 256 290.133Z"
                                    fill="#fff" />
                                <defs>
                                    <linearGradient id="paint_phone" x1="136.533" x2="375.467" y1="136.533"
                                        y2="375.467">
                                        <stop stop-color="#fff" />
                                        <stop offset="1" stop-color="#e0f2fe" />
                                    </linearGradient>
                                </defs>
                            </svg>
                            <h3 class="phone-login-title">Skin<span class="brand-x">X</span>pert</h3>
                            <p class="phone-login-subtitle">Iniciar sesión</p>
                            <input type="text" class="phone-login-input" placeholder="Email o cédula" id="heroEmail">
                            <input type="password" class="phone-login-input" placeholder="Contraseña" id="heroPassword">
                            <button class="phone-login-btn" onclick="handleHeroLogin()">Entrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section id="caracteristicas" class="features-section">
            <div class="section-header">
                <h2 class="section-title animate-on-scroll">Características Principales</h2>
                <p class="section-description animate-on-scroll">
                    Tecnología médica de vanguardia diseñada para cuidar de tu piel
                    con la mayor precisión y facilidad.
                </p>
            </div>
            <div class="features-grid">
                <div class="feature-card animate-on-scroll">
                    <div class="feature-icon">
                        <i class="fa-solid fa-brain"></i>
                    </div>
                    <h3 class="feature-title">IA Avanzada</h3>
                    <p class="feature-description">
                        Algoritmos de aprendizaje profundo especializados en detectar cánceres de piel
                        y enfermedades dermatológicas. Prioriza casos según urgencia para atención médica oportuna.
                    </p>
                </div>
                <div class="feature-card animate-on-scroll">
                    <div class="feature-icon">
                        <i class="fa-solid fa-camera"></i>
                    </div>
                    <h3 class="feature-title">Análisis con IA y Revisión Médica</h3>
                    <p class="feature-description">
                        Captura una foto de tu piel. La IA analiza y detecta posibles problemas,
                        asignando un nivel de urgencia. Tu médico revisa el diagnóstico y programa una cita según la
                        prioridad.
                    </p>
                </div>
                <div class="feature-card animate-on-scroll">
                    <div class="feature-icon">
                        <i class="fa-solid fa-lock"></i>
                    </div>
                    <h3 class="feature-title">100% Privado</h3>
                    <p class="feature-description">
                        Tus datos de salud están encriptados y nunca son compartidos.
                        Tu privacidad es nuestra prioridad.
                    </p>
                </div>
                <div class="feature-card animate-on-scroll">
                    <div class="feature-icon">
                        <i class="fa-solid fa-file-medical"></i>
                    </div>
                    <h3 class="feature-title">Historial Completo</h3>
                    <p class="feature-description">
                        Guarda y compara análisis a lo largo del tiempo para monitorear
                        cambios en tu piel.
                    </p>
                </div>
                <div class="feature-card animate-on-scroll">
                    <div class="feature-icon">
                        <i class="fa-solid fa-bolt"></i>
                    </div>
                    <h3 class="feature-title">Alertas Inteligentes</h3>
                    <p class="feature-description">
                        Recibe notificaciones si detectamos cambios significativos que
                        requieran atención médica.
                    </p>
                </div>
                <div class="feature-card animate-on-scroll">
                    <div class="feature-icon">
                        <i class="fa-solid fa-heart-pulse"></i>
                    </div>
                    <h3 class="feature-title">Prevención Proactiva</h3>
                    <p class="feature-description">
                        Detecta problemas tempranos cuando son más tratables.
                        Tu salud es lo primero.
                    </p>
                </div>
            </div>
        </section>

        <!-- How It Works Section - NUEVA ANIMACIÓN -->
        <section id="como-funciona" class="how-it-works-section">
            <div class="section-header">
                <h2 class="section-title animate-on-scroll">Cómo Funciona</h2>
                <p class="section-description animate-on-scroll">
                    En solo 3 simples pasos, puedes obtener un análisis profesional de tu piel.
                </p>
            </div>

            <div class="phone-animation-container">
                <div class="animated-phone">
                    <div class="phone-notch"></div>
                    <div class="phone-screen">
                        <!-- Step 1: Captura -->
                        <div class="step-animation active" id="step1">
                            <div class="step-icon-large">
                                <i class="fa-solid fa-camera"></i>
                            </div>
                            <div class="step-text">
                                <h3>Captura</h3>
                                <p>Toma una foto clara de la zona de piel que deseas analizar usando tu smartphone</p>
                            </div>
                        </div>

                        <!-- Step 2: Análisis -->
                        <div class="step-animation" id="step2">
                            <div class="step-icon-large">
                                <i class="fa-solid fa-magnifying-glass-chart"></i>
                            </div>
                            <div class="step-text">
                                <h3>Análisis</h3>
                                <p>Nuestra IA analiza la imagen en segundos, comparándola con miles de casos
                                    dermatológicos</p>
                            </div>
                        </div>

                        <!-- Step 3: Resultados -->
                        <div class="step-animation" id="step3">
                            <div class="step-icon-large">
                                <i class="fa-solid fa-file-circle-check"></i>
                            </div>
                            <div class="step-text">
                                <h3>Resultados</h3>
                                <p>Recibe un informe detallado con recomendaciones y si es necesario, consultar a un
                                    especialista</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="steps-indicators">
                    <div class="step-indicator active" onclick="changeStep(1)">
                        <div class="step-number-indicator">01</div>
                        <div class="step-label">Captura</div>
                    </div>
                    <div class="step-indicator" onclick="changeStep(2)">
                        <div class="step-number-indicator">02</div>
                        <div class="step-label">Análisis</div>
                    </div>
                    <div class="step-indicator" onclick="changeStep(3)">
                        <div class="step-number-indicator">03</div>
                        <div class="step-label">Resultados</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Testimonials Section -->
        <section id="testimonios" class="testimonials-section">
            <div class="section-header">
                <h2 class="section-title animate-on-scroll">Lo Que Dicen Nuestros Usuarios</h2>
                <p class="section-description animate-on-scroll">
                    Miles de personas confían en SkinXpert para cuidar de su salud dermatológica.
                </p>
            </div>
            <div class="testimonials-grid">
                <div class="testimonial-card animate-on-scroll">
                    <div class="stars">
                        <i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i>
                    </div>
                    <p class="testimonial-text">
                        "Esta app me ayudó a detectar un lunar sospechoso que luego fue confirmado por mi dermatólogo.
                        La detección temprana hizo toda la diferencia."
                    </p>
                    <div class="testimonial-author">María González</div>
                    <div class="testimonial-role">Usuario SkinXpert</div>
                </div>
                <div class="testimonial-card animate-on-scroll">
                    <div class="stars">
                        <i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i>
                    </div>
                    <p class="testimonial-text">
                        "Muy fácil de usar y rápida. Me da tranquilidad poder monitorear mi piel regularmente
                        sin tener que esperar citas médicas."
                    </p>
                    <div class="testimonial-author">Carlos Ruiz</div>
                    <div class="testimonial-role">Usuario SkinXpert</div>
                </div>
                <div class="testimonial-card animate-on-scroll">
                    <div class="stars">
                        <i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i>
                    </div>
                    <p class="testimonial-text">
                        "La interfaz es intuitiva y los resultados son claros. Excelente herramienta para
                        el cuidado preventivo de la piel."
                    </p>
                    <div class="testimonial-author">Ana Martínez</div>
                    <div class="testimonial-role">Usuario SkinXpert</div>
                </div>
            </div>
        </section>

        <!-- Download Section -->
        <section id="descargar" class="download-section">
            <div class="download-content">
                <div class="section-header">
                    <h2 class="section-title animate-on-scroll">Descarga SkinXpert</h2>
                    <p class="section-description animate-on-scroll">
                        Disponible para iOS y Android. Comienza a cuidar tu salud dermatológica hoy mismo.
                    </p>
                </div>

                <div class="download-options">
                    <div class="download-card animate-on-scroll">
                        <div class="download-icon">
                            <i class="fa-brands fa-apple"></i>
                        </div>
                        <h3 class="download-platform">iOS</h3>
                        <p class="download-description">
                            Compatible con iPhone y iPad.<br>
                            Requiere iOS 14.0 o superior.
                        </p>
                        <button class="download-btn">
                            <i class="fa-solid fa-download"></i>
                            Descargar en App Store
                        </button>
                    </div>

                    <div class="download-card animate-on-scroll">
                        <div class="download-icon">
                            <i class="fa-brands fa-android"></i>
                        </div>
                        <h3 class="download-platform">Android</h3>
                        <p class="download-description">
                            Compatible con dispositivos Android.<br>
                            Requiere Android 8.0 o superior.
                        </p>
                        <button class="download-btn">
                            <i class="fa-solid fa-download"></i>
                            Descargar en Google Play
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- CTA Section -->
        <section class="cta-section">
            <div class="cta-content">
                <div class="cta-icon animate-on-scroll">
                    <i class="fa-solid fa-shield-heart"></i>
                </div>
                <h2 class="cta-title animate-on-scroll">Protege tu Piel Hoy</h2>
                <p class="cta-description animate-on-scroll">
                    La detección temprana puede salvar vidas. Descarga SkinXpert y comienza
                    a cuidar de tu salud dermatológica con la confianza de la tecnología médica avanzada.
                </p>
                <div class="cta-buttons">
                    <button class="btn-white animate-on-scroll" onclick="showLogin()">
                        <i class="fa-solid fa-right-to-bracket"></i>
                        Acceder a la Plataforma
                    </button>
                </div>
                <p class="cta-note animate-on-scroll">
                    Sistema disponible para médicos y pacientes
                </p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-top">
                    <div class="footer-brand">
                        <h3>SkinXpert</h3>
                        <p>Tecnología médica avanzada para la detección temprana de problemas de piel. Tu salud
                            dermatológica es nuestra prioridad.</p>
                    </div>
                    <div class="footer-section">
                        <h4>Enlaces</h4>
                        <div class="footer-links">
                            <a href="#sobre-nosotros">Sobre Nosotros</a>
                            <a href="#privacidad">Privacidad</a>
                            <a href="#terminos">Términos de Uso</a>
                            <a href="#soporte">Soporte</a>
                        </div>
                    </div>
                    <div class="footer-section">
                        <h4>Contacto</h4>
                        <div class="footer-links">
                            <a href="mailto:contacto@skinxpert.com">contacto@skinxpert.com</a>
                            <a href="#">Av. Salud Digital 123</a>
                            <a href="#">Ciudad, País</a>
                        </div>
                    </div>
                </div>
                <div class="footer-bottom">
                    <div class="footer-copyright">
                        © 2025 SkinXpert. Todos los derechos reservados.
                    </div>
                    <div class="footer-legal">
                        <a href="#privacidad">Privacidad</a>
                        <a href="#terminos">Términos</a>
                        <a href="#cookies">Cookies</a>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- WRAPPER PARA EFECTO DE DESPLAZAMIENTO -->
    <div class="main-content">

        <!-- PANTALLA LOGIN -->
        <div id="loginPage" class="container hidden" style="max-width: 450px; text-align: center;">
            <div style="text-align: center;">
                <svg class="login-logo-inner" fill="none" preserveAspectRatio="none" viewBox="0 0 512 512">
                    <g>
                        <path
                            d="M256 448C362.039 448 448 362.039 448 256C448 149.961 362.039 64 256 64C149.961 64 64 149.961 64 256C64 362.039 149.961 448 256 448Z"
                            opacity="0.3" stroke="url(#paint0_linear_login)" stroke-width="25.6" />
                        <path d="M256 64C306.922 64 355.758 84.2285 391.765 120.235C427.772 156.242 448 205.078 448 256"
                            stroke="url(#paint1_linear_login)" stroke-linecap="round" stroke-width="34.1333" />
                        <path
                            d="M256 375.467C321.98 375.467 375.467 321.98 375.467 256C375.467 190.02 321.98 136.533 256 136.533C190.02 136.533 136.533 190.02 136.533 256C136.533 321.98 190.02 375.467 256 375.467Z"
                            fill="url(#paint2_linear_login)" opacity="0.85" />
                        <path
                            d="M256 307.2C284.277 307.2 307.2 284.277 307.2 256C307.2 227.723 284.277 204.8 256 204.8C227.723 204.8 204.8 227.723 204.8 256C204.8 284.277 227.723 307.2 256 307.2Z"
                            fill="white" />
                        <path
                            d="M256 290.133C274.851 290.133 290.133 274.851 290.133 256C290.133 237.149 274.851 221.867 256 221.867C237.149 221.867 221.867 237.149 221.867 256C221.867 274.851 237.149 290.133 256 290.133Z"
                            fill="#0EA5E9" />
                        <path d="M128 170.667V128H170.667" stroke="#0EA5E9" stroke-linecap="round"
                            stroke-width="21.3333" />
                        <path d="M384 170.667V128H341.333" stroke="#0EA5E9" stroke-linecap="round"
                            stroke-width="21.3333" />
                        <path d="M128 341.333V384H170.667" stroke="#38BDF8" stroke-linecap="round"
                            stroke-width="21.3333" />
                        <path d="M384 341.333V384H341.333" stroke="#38BDF8" stroke-linecap="round"
                            stroke-width="21.3333" />
                    </g>
                    <defs>
                        <linearGradient gradientUnits="userSpaceOnUse" id="paint0_linear_login" x1="64" x2="38464"
                            y1="64" y2="38464">
                            <stop stop-color="#0EA5E9" />
                            <stop offset="1" stop-color="#38BDF8" />
                        </linearGradient>
                        <linearGradient gradientUnits="userSpaceOnUse" id="paint1_linear_login" x1="256" x2="19456"
                            y1="64" y2="19264">
                            <stop stop-color="#0EA5E9" />
                            <stop offset="1" stop-color="#38BDF8" />
                        </linearGradient>
                        <linearGradient gradientUnits="userSpaceOnUse" id="paint2_linear_login" x1="136.533"
                            x2="24029.9" y1="136.533" y2="24029.9">
                            <stop stop-color="#38BDF8" />
                            <stop offset="0.5" stop-color="#0EA5E9" />
                            <stop offset="1" stop-color="#1C3555" />
                        </linearGradient>
                    </defs>
                </svg>
            </div>

            <h2>Skin<span class="brand-x">X</span>pert</h2>
            <p>Iniciar sesión para continuar</p>

            <input id="email" type="text" placeholder="Correo electrónico o cédula">
            <input id="password" type="password" placeholder="Contraseña">

            <button onclick="handleLogin()">Iniciar Sesión</button>

            <div style="margin-top: 20px;">
                <button onclick="showLanding()" class="btn-secondary" style="width: 100%;">
                    <i class="fa-solid fa-arrow-left"></i> Volver al inicio
                </button>
            </div>
        </div>

        <!-- DASHBOARD PACIENTE -->
        <div id="patientDashboard" class="container hidden">
            <div class="header-flex">
                <div>
                    <h2 style="font-size: 32px;">Hola, <span id="p_name">Paciente</span></h2>
                    <span class="role-badge">Paciente</span>
                </div>
                <button class="btn-secondary" style="width: auto; margin:0;" onclick="logout()">Cerrar Sesión</button>
            </div>

            <div class="tabs reveal-on-scroll">
                <button class="tab-btn active" onclick="openTab('p-consult', this)">Consulta</button>
                <button class="tab-btn" onclick="openTab('p-citas', this)">Citas</button>
                <button class="tab-btn" onclick="openTab('p-historial', this)">Historial</button>
            </div>

            <div id="p-consult" class="tab-content active">
                <div class="case-card reveal-on-scroll" style="text-align: center; padding: 50px;">
                    <i class="fa-solid fa-camera" style="font-size: 50px; color: #d2d2d7; margin-bottom: 20px;"></i>
                    <h3>Nueva Consulta</h3>
                    <p>Sube una foto de tu lesión para que tu médico pueda evaluarla</p>
                    <div id="uploadMessage" style="
                        display:none;
                        margin:15px 0;
                        padding:12px;
                        border-radius:8px;
                        font-size:14px;
                        font-weight:600;
                    ">
                    </div>
                    <img id="imagePreview" style="
                        display:none;
                        margin:20px auto;
                        max-width:100%;
                        max-height:300px;
                        border-radius:12px;
                        box-shadow:0 10px 25px rgba(0,0,0,0.15);
                    " />
                    <input type="file" id="uploadImage" accept="image/*" capture="environment"
                        onchange="previewImage(event)" style="margin-top:15px;">
                    <button style="margin-top:20px;" onclick="uploadCase()">Enviar Consulta</button>
                </div>
            </div>

            <div id="p-citas" class="tab-content">
                <div id="patientAppointmentsList"></div>
            </div>

            <div id="p-historial" class="tab-content">
                <div id="patientHistoryList"></div>
            </div>
        </div>

        <!-- DASHBOARD DOCTOR -->
        <div id="doctorDashboard" class="container hidden" style="max-width: 900px;">
            <div class="header-flex">
                <div>
                    <h2 style="font-size: 32px;"><span id="d_name">Médico</span></h2>
                    <span class="role-badge">Dermatología</span>
                </div>
                <button class="btn-secondary" style="width: auto; margin:0;" onclick="logout()">Exit</button>
            </div>

            <div class="tabs reveal-on-scroll">
                <button class="tab-btn active" onclick="openTab('d-pending', this)">Pendientes</button>
                <button class="tab-btn" onclick="openTab('d-patients', this)">Pacientes</button>
                <button class="tab-btn" onclick="openTab('d-citas', this)">Agenda</button>
                <button class="tab-btn" onclick="openTab('d-camera', this)">Cámara</button>
            </div>

            <div id="d-pending" class="tab-content active">
                <p class="reveal-on-scroll" style="font-size:14px; color:var(--text-secondary); margin-bottom:20px;">
                    <i class="fa-solid fa-arrow-down-short-wide"></i> Ordenado por Urgencia (IA)
                </p>
                <div id="doctorPendingList"></div>
            </div>

            <div id="d-patients" class="tab-content">
                <div id="doctorPatientsList"></div>
            </div>

            <div id="d-citas" class="tab-content">
                <div id="doctorAppointmentsList"></div>
            </div>

            <div id="d-camera" class="tab-content">
                <div class="case-card reveal-on-scroll" style="background:#000; color:white; text-align:center;">
                    <h3 style="color:white; margin-bottom:10px;">Visor Dermatoscopio</h3>
                    <video id="camera-preview" autoplay playsinline
                        style="width:100%; border-radius:12px; background:#333; display:none;"></video>
                    <div style="padding-top:20px;">
                        <button id="btnCamera" class="btn-secondary" onclick="toggleCamera()"
                            style="background:white !important; color:black !important; width:auto;">
                            <i class="fa-solid fa-camera"></i> Iniciar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADMIN DASHBOARD -->
        <div id="adminDashboard" class="container hidden" style="max-width:1000px;">
            <div class="header-flex">
                <h2>Panel Admin</h2>
                <button class="btn-secondary" style="width: auto; margin:0;" onclick="logout()">Exit</button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="openTab('admin-doctors', this)">Doctors</button>
                <button class="tab-btn" onclick="openTab('admin-patients', this)">Patients</button>
            </div>

            <div id="admin-doctors" class="tab-content active">
                <div id="adminDoctorsList"></div>
                <button class="btn-primary" onclick="openNewDoctor(); scrollToBottom();">
                    New
                </button>
            </div>

            <div id="admin-patients" class="tab-content">
                <div id="adminPatientsList"></div>
                <button class="btn-primary" onclick="openNewPatient(); scrollToBottom();">
                    New
                </button>
            </div>
        </div>

    </div>

    <!-- MODAL NEW DOCTOR / PATIENT -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <div id="modal-body"></div>

            <div class="modal-actions" style="margin: 15px 100px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn-primary" id="modalSaveBtn" onclick="modalSave()">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        const API = "http://localhost:1880";

        // Sistema de navegación con History API
        let currentView = 'landing';

        // ANIMACIÓN DE CARGA - Mostrar durante 3 segundos
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('logoLoader').classList.add('hidden');
                document.getElementById('landingPage').classList.remove('hidden');
                animateOnScroll();
            }, 3000);
        });

        // PREVIEW DE IMAGEN
        function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById("imagePreview");

            if (!file) {
                preview.style.display = "none";
                return;
            }

            const reader = new FileReader();
            reader.onload = () => {
                preview.src = reader.result;
                preview.style.display = "block";
            };
            reader.readAsDataURL(file);
        }

        // LOGIN DESDE EL HERO
        function handleHeroLogin() {
            const email = document.getElementById("heroEmail").value.trim();
            const password = document.getElementById("heroPassword").value.trim();

            if (!email || !password) {
                alert("Por favor completa todos los campos.");
                return;
            }

            // Usar la misma función de login
            document.getElementById("email").value = email;
            document.getElementById("password").value = password;
            handleLogin();
        }

        // ANIMACIÓN DE PASOS "CÓMO FUNCIONA"
        let currentStep = 1;
        let stepInterval;

        function changeStep(step) {
            document.querySelectorAll('.step-animation').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.step-indicator').forEach(i => i.classList.remove('active'));

            document.getElementById('step' + step).classList.add('active');
            document.querySelectorAll('.step-indicator')[step - 1].classList.add('active');

            currentStep = step;
        }

        function autoChangeStep() {
            currentStep = currentStep >= 3 ? 1 : currentStep + 1;
            changeStep(currentStep);
        }

        stepInterval = setInterval(autoChangeStep, 4000);

        function updateHistory(view) {
            currentView = view;
            history.pushState({ view: view }, '', `#${view}`);
        }

        window.addEventListener('popstate', function (event) {
            if (event.state && event.state.view) {
                navigateToView(event.state.view);
            } else {
                navigateToView('landing');
            }
        });

        function navigateToView(view) {
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('patientDashboard').classList.add('hidden');
            document.getElementById('doctorDashboard').classList.add('hidden');
            document.getElementById('adminDashboard').classList.add('hidden');

            if (view === 'landing') {
                document.getElementById('landingPage').classList.remove('hidden');
            } else if (view === 'login') {
                document.getElementById('loginPage').classList.remove('hidden');
            } else if (view === 'patient') {
                document.getElementById('patientDashboard').classList.remove('hidden');
            } else if (view === 'doctor') {
                document.getElementById('doctorDashboard').classList.remove('hidden');
            } else if (view === 'admin') {
                document.getElementById('adminDashboard').classList.remove('hidden');
            }

            currentView = view;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showLogin() {
            updateHistory('login');
            document.getElementById('landingPage').classList.add('hidden');
            document.getElementById('loginPage').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showLanding() {
            updateHistory('landing');
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('landingPage').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        const animateOnScroll = () => {
            const elements = document.querySelectorAll('.animate-on-scroll, .animate-scale');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            });

            elements.forEach(el => observer.observe(el));
        };

        const observerOptions = { root: null, rootMargin: '0px', threshold: 0.1 };
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        function initScrollAnimations() {
            const elements = document.querySelectorAll('.case-card, .container, .tabs, .reveal-on-scroll');
            elements.forEach(el => observer.observe(el));
        }

        function scrollToBottom() {
            setTimeout(() => {
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: "smooth"
                });
            }, 150);
        }

        async function handleLogin() {
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value.trim();

            if (!email || !password) return alert("Por favor completa todos los campos.");

            try {
                const res = await fetch(`${API}/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();

                if (!data.success) {
                    alert("Credenciales incorrectas.");
                    return;
                }

                document.getElementById("loginPage").classList.add("hidden");
                document.getElementById("landingPage").classList.add("hidden");

                const role = data.role.toLowerCase();

                if (role === "patient" || role === "patients") {
                    updateHistory('patient');
                    document.getElementById("patientDashboard").classList.remove("hidden");
                    document.getElementById("p_name").innerText = data.user.name;
                    localStorage.setItem("patient_id", data.user.id);
                    localStorage.setItem("token", data.token);

                    loadPatientHistory();
                    loadPatientAppointments();

                } else if (role === "doctor" || role === "doctors") {
                    updateHistory('doctor');
                    document.getElementById("doctorDashboard").classList.remove("hidden");
                    document.getElementById("d_name").innerText = data.user.name;
                    localStorage.setItem("doctor_id", data.user.id);
                    localStorage.setItem("token", data.token);

                    loadDoctorPatients();
                    loadDoctorPending();
                    loadDoctorAppointments();

                } else if (role === "admin") {
                    updateHistory('admin');
                    document.getElementById("adminDashboard").classList.remove("hidden");
                    loadAdminDoctors();
                    loadAdminPatients();
                }

                setTimeout(initScrollAnimations, 100);

            } catch (error) {
                console.error(error);
                alert("Error de conexión.");
            }
        }

        function logout() {
            location.reload();
        }

        function openTab(tabId, btnElement) {
            const activeDashboard = document.querySelector('.container:not(.hidden)');

            if (activeDashboard) {
                activeDashboard.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                activeDashboard.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

                const targetContent = activeDashboard.querySelector(`#${tabId}`);
                if (targetContent) targetContent.classList.add('active');

                if (btnElement) btnElement.classList.add('active');
            }
            setTimeout(initScrollAnimations, 50);
        }

        async function loadPatientHistory() {
            const patientId = localStorage.getItem("patient_id");
            try {
                const res = await fetch(`${API}/patient/history?id_patient=${patientId}`);
                const history = await res.json();
                const list = document.getElementById("patientHistoryList");
                list.innerHTML = "";

                if (!history.length) {
                    list.innerHTML = `<div class="case-card"><p style="color:#888;">No se encontró historial.</p></div>`;
                    return;
                }

                history.forEach(h => {
                    const fecha = new Date(h.diagnosis_date).toLocaleDateString("es-ES");
                    list.innerHTML += `
            <div class="case-card urgency-low">
                <p style="font-size:14px; color:#888;">${fecha}</p>
                <div style="display:flex; gap:15px; margin-top:10px;">
                    <img src="${h.file_path || 'https://via.placeholder.com/100'}" style="width:80px; height:80px; border-radius:8px; object-fit: cover;">
                    <div>
                        <strong>${h.disease}</strong>
                        <p style="margin-top:5px; font-size:14px;">${h.doctor_notes || ''}</p>
                    </div>
                </div>
            </div>`;
                });
                initScrollAnimations();
            } catch (err) { console.error(err); }
        }

        async function loadPatientAppointments() {
            const patientId = localStorage.getItem("patient_id");

            try {
                const res = await fetch(`${API}/patient/appointments?id_patient=${patientId}`);
                const citas = await res.json();

                const list = document.getElementById("patientAppointmentsList");
                list.innerHTML = "";

                if (!citas.length) {
                    list.innerHTML = `
                <div class="case-card">
                    <p style="color:#888;">No tienes citas próximas.</p>
                </div>`;
                    return;
                }

                citas.forEach(c => {
                    const fecha = new Date(c.date);
                    const dia = fecha.getDate().toString().padStart(2, '0');
                    const mes = fecha.toLocaleString('es-ES', { month: 'short' }).toUpperCase();
                    const hora = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

                    list.innerHTML += `
                <div class="case-card urgency-medium">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h4 style="margin:0;">Cita con ${c.doctor_name}</h4>
                            <p style="margin:5px 0 0 0; color:#64748B;">
                                Estado: ${c.status}
                            </p>
                        </div>
                        <div style="text-align:right;">
                            <span style="font-weight:bold; color:var(--sk-blue-dark);">
                                ${dia} ${mes}
                            </span><br>
                            <span style="font-size:14px;">${hora}</span>
                        </div>
                    </div>
                </div>`;
                });

                initScrollAnimations();

            } catch (err) {
                console.error(err);
                alert("Error cargando citas");
            }
        }

        async function loadDoctorPending() {
            const doctorId = localStorage.getItem("doctor_id");
            const res = await fetch(`${API}/doctor/pending?id_doctor=${doctorId}`);
            const cases = await res.json();
            const list = document.getElementById("doctorPendingList");
            list.innerHTML = "";

            const AHORA = Date.now();
            const TREINTA_MINUTOS_MS = 30 * 60 * 1000;

            cases.forEach(c => {
                let badgeClass = 'badge-low';
                let cardClass = 'urgency-low';
                let alertaRetraso = "";

                if (c.urgency === 3) { badgeClass = 'badge-high'; cardClass = 'urgency-high'; }
                else if (c.urgency === 2) { badgeClass = 'badge-medium'; cardClass = 'urgency-medium'; }

                const tiempoEsperaMs = AHORA - c.ia_confidence_millis;
                const minutosEspera = Math.floor(tiempoEsperaMs / (1000 * 60));

                if (tiempoEsperaMs > TREINTA_MINUTOS_MS) {
                    alertaRetraso = `
                <div style="background: #fee2e2; color: #b91c1c; padding: 8px; border-radius: 8px; margin-top: 10px; font-size: 13px; font-weight: bold; border: 1px solid #f87171;">
                    <i class="fa-solid fa-triangle-exclamation"></i> 
                    ALERTA: Paciente esperando hace ${minutosEspera} min.
                </div>`;
                }

                list.innerHTML += `
            <div class="case-card ${cardClass}">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>${c.name}</h3>
                    <span class="urgency-badge ${badgeClass}">${Math.round(c.ia_confidence)}% RIESGO IA</span>
                </div>
                
                <img src="http://localhost:8080${c.file_path}" style="width:100%; height:200px; object-fit:cover; margin: 15px 0; border-radius:12px; border: 1px solid #eee;">
                
                <div style="background: #f0f9ff; padding: 10px; border-radius: 8px; margin-bottom: 5px; border-left: 4px solid #0ea5e9;">
                    <p style="margin:0; font-size:12px; color:#0369a1; font-weight:bold;">SUGERENCIA IA:</p>
                    <p style="margin:0; font-size:15px; color:#1e40af;">${c.ia_suggestion || 'Analizando...'}</p>
                </div>

                ${alertaRetraso}
                
                <div style="margin-top:15px;">
                    <label style="font-size:12px; font-weight:bold;">Diagnóstico Final:</label>
                    <select id="disease-${c.id_request}" style="width:100%; padding:10px; margin: 8px 0;">
                        <option value="1">Acné</option>
                        <option value="2">Queratosis / Carcinoma</option>
                        <option value="12">Melanoma</option>
                        <option value="15">Psoriasis</option>
                    </select>
                    <textarea id="notes-${c.id_request}" placeholder="Tratamiento..." rows="2" style="width:100%; padding:10px;"></textarea>
                    <input type="datetime-local" id="appointment-${c.id_request}" style="width:100%; padding:10px; margin-top:10px;">
                    <button onclick="sendDiagnosis(${c.id_request}, ${doctorId}, ${c.id_patient})" style="margin-top:10px;">Completar Revisión</button>
                </div>
            </div>`;
            });
            initScrollAnimations();
        }

        async function loadDoctorPatients() {
            const doctorId = localStorage.getItem("doctor_id");

            try {
                const res = await fetch(`${API}/doctor/patients?id_doctor=${doctorId}`);
                const patients = await res.json();

                const list = document.getElementById("doctorPatientsList");
                list.innerHTML = "";

                patients.forEach(p => {
                    list.innerHTML += `
                <div class="case-card reveal-on-scroll"
                    style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${p.name}</strong><br>
                        <span style="font-size:14px; color:#888;">
                            ID: ${p.dni} • ${p.email}
                        </span>
                    </div>
                </div>
            `;
                });

                initScrollAnimations();

            } catch (err) {
                console.error(err);
                alert("Error loading patients");
            }
        }

        async function loadDoctorAppointments() {
            const doctorId = localStorage.getItem("doctor_id");

            try {
                const res = await fetch(`${API}/doctor/appointments?id_doctor=${doctorId}`);
                const citas = await res.json();

                const list = document.getElementById("doctorAppointmentsList");
                list.innerHTML = "";

                if (!citas.length) {
                    list.innerHTML = `
                <div class="case-card reveal-on-scroll">
                    <p style="color:#888;">No hay citas programadas.</p>
                </div>`;
                    return;
                }

                citas.forEach(c => {
                    const fecha = new Date(c.date);
                    const dia = fecha.getDate().toString().padStart(2, '0');
                    const mes = fecha.toLocaleString('es-ES', { month: 'short' }).toUpperCase();
                    const hora = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

                    let estadoColor = "#999";
                    if (c.status === 'pending') estadoColor = "#d39e00";
                    if (c.status === 'done') estadoColor = "#28a745";
                    if (c.status === 'cancel') estadoColor = "#dc3545";

                    list.innerHTML += `
                <div class="case-card reveal-on-scroll" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${c.patient_name}</strong><br>
                        <span style="font-size:14px; color:#888;">Estado:
                            <b style="color:${estadoColor};">${c.status}</b>
                        </span><br>
                        <span style="font-size:14px;">${dia} ${mes} • ${hora}</span>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-secondary" onclick="editAppointment(${c.id_appointment}, '${c.date}', ${c.id_patient})">Edit</button>
                        <button class="btn-secondary" style="color:red;" onclick="deleteAppointment(${c.id_appointment}, ${c.id_patient})">Delete</button>
                    </div>
                </div>
            `;
                });

                initScrollAnimations();

            } catch (err) {
                console.error(err);
                alert("Error loading appointments.");
            }
        }

        async function uploadCase() {
            const fileInput = document.getElementById("uploadImage");
            const patientId = localStorage.getItem("patient_id");

            if (fileInput.files.length === 0) {
                return alert("Por favor, selecciona una imagen primero.");
            }

            const file = fileInput.files[0];
            const formData = new FormData();

            formData.append("foto", file);
            formData.append("id_patient", patientId);

            try {
                const response = await fetch(`${API}/upload-case`, {
                    method: "POST",
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    alert("Consulta enviada con éxito. La IA está analizando tu caso.");
                    //loadPatientHistory();
                } else {
                    alert("Error al enviar la consulta.");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("No se pudo conectar con el servidor.");
            }
        }

        async function sendDiagnosis(reqId, docId, patId) {
            const diseaseSelect = document.getElementById(`disease-${reqId}`);
            const notesInput = document.getElementById(`notes-${reqId}`);
            const appointmentInput = document.getElementById(`appointment-${reqId}`);

            const diseaseId = diseaseSelect.value;
            const notes = notesInput.value;

            if (!notes) {
                alert("Por favor escribe algunas notas para el paciente.");
                return;
            }

            const payload = {
                id_request: reqId,
                id_doctor: docId,
                id_patient: patId,
                id_skindiseases: parseInt(diseaseId),
                confidence: 100,
                doctor_notes: notes,
                appointment_date: appointmentInput.value
            };

            try {
                const res = await fetch(`${API}/doctor/send_report`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const result = await res.json();

                if (res.ok) {
                    alert("Reporte enviado correctamente");
                    loadDoctorPending();
                    loadDoctorAppointments();
                } else {
                    alert("Error: " + JSON.stringify(result));
                }
            } catch (e) {
                console.error(e);
                alert("Error de conexión al enviar el reporte.");
            }
        }

        async function editAppointment(id_appointment, currentDate, patientId) {
            const newDate = prompt("Selecciona nueva fecha y hora (YYYY-MM-DDTHH:MM):", currentDate.slice(0, 16));
            if (!newDate) return;

            try {
                const res = await fetch(`${API}/appointment/${id_appointment}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ date: newDate })
                });

                if (res.ok) {
                    alert("Cita actualizada correctamente!");
                    await loadDoctorAppointments();
                    await loadPatientAppointments();
                } else {
                    const data = await res.json();
                    alert("Error al actualizar cita: " + JSON.stringify(data));
                }
            } catch (err) {
                console.error(err);
                alert("Error de conexión al actualizar cita");
            }
        }

        async function deleteAppointment(id_appointment, patientId) {
            if (!confirm("¿Estás seguro de eliminar esta cita y su diagnóstico?")) return;

            try {
                const res = await fetch(`${API}/appointment/${id_appointment}`, {
                    method: "DELETE"
                });

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(JSON.stringify(data));
                }

                await loadDoctorAppointments();
                await loadPatientAppointments();
                await loadPatientHistory();

                alert("Cita eliminada correctamente!");

            } catch (err) {
                console.error(err);
                alert("Error al eliminar cita");
            }
        }

        let stream = null;
        async function toggleCamera() {
            const video = document.getElementById('camera-preview');
            const btn = document.getElementById('btnCamera');

            if (video.style.display === 'none') {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                    video.srcObject = stream;
                    video.style.display = 'block';
                    btn.innerText = "Detener";
                    btn.style.color = "red";
                } catch (e) { alert("Cámara no disponible"); }
            } else {
                if (stream) stream.getTracks().forEach(t => t.stop());
                video.style.display = 'none';
                btn.innerText = "Iniciar";
                btn.style.color = "black";
            }
        }

        // ADMIN FUNCTIONS
        async function loadAdminDoctors() {
            const res = await fetch(`${API}/admin/doctors`);
            const doctors = await res.json();

            const list = document.getElementById("adminDoctorsList");
            list.innerHTML = "";

            doctors.forEach(d => {
                list.innerHTML += `
        <div class="case-card" style="display:flex;justify-content:space-between;">
            <div>
                <strong>${d.name}</strong><br>
                <span style="color:#888">${d.email} • ${d.clinic || ''}</span>
            </div>
            <div>
                <button class="btn-secondary" style="color:red;"
                        onclick="editDoctor(${d.id_doctor})">
                    Edit
                </button>
                <button class="btn-secondary" style="color:red;"
                        onclick="deleteDoctor(${d.id_doctor})">
                    Delete
                </button>   
            </div>
        </div>`;
            });
        }

        async function loadAdminPatients() {
            const res = await fetch(`${API}/admin/patients`);
            const patients = await res.json();

            const list = document.getElementById("adminPatientsList");
            list.innerHTML = "";

            patients.forEach(p => {
                list.innerHTML += `
        <div class="case-card" style="display:flex;justify-content:space-between;">
            <div>
                <strong>${p.name}</strong><br>
                <span style="color:#888">${p.email} • Doctor: ${p.doctor || '—'}</span>
            </div>
            <div>
                <button class="btn-secondary" style="color:red;" onclick="editPatient(${p.id_patient})">
                    Edit
                </button>
                <button class="btn-secondary" style="color:red;"
                        onclick="deletePatient(${p.id_patient})">
                    Delete
                </button>
            </div>
        </div>`;
            });
        }

        async function deleteDoctor(id) {
            if (!confirm("¿Estás seguro de eliminar este doctor y TODOS los datos relacionados?")) return;

            const res = await fetch(`${API}/admin/doctor/${id}`, {
                method: "DELETE"
            });

            const data = await res.json();

            if (res.ok) {
                alert("Doctor eliminado correctamente");
                loadAdminDoctors();
                loadAdminPatients();
            } else {
                alert("Error al eliminar doctor");
            }
        }

        async function deletePatient(id) {
            if (!confirm("¿Estás seguro de eliminar este paciente y TODOS los datos relacionados?")) return;

            const res = await fetch(`${API}/admin/patient/${id}`, {
                method: "DELETE"
            });

            const data = await res.json();

            if (res.ok) {
                alert("Paciente eliminado correctamente");
                loadAdminPatients();
            } else {
                alert("Error al eliminar paciente");
            }
        }

        function openNewDoctor() {
            document.getElementById("modal-title").innerText = "New Doctor";

            document.getElementById("modal-body").innerHTML = `
        <div style="margin:20px 100px;">
            <input id="new_doctor_code" placeholder="Código Doctor">
            <input id="new_doctor_name" placeholder="Nombre Completo">
            <input id="new_doctor_email" placeholder="Correo electrónico">
            <input id="new_doctor_password" type="password" placeholder="Contraseña Temporal">
            <input id="new_doctor_clinic" placeholder="ID Clínica (opcional)">
        </div>
    `;

            openModal("doctor", false);
        }

        function openNewPatient() {
            document.getElementById("modal-title").innerText = "New Patient";

            document.getElementById("modal-body").innerHTML = `
        <div style="margin:20px 100px;">
            <input id="new_patient_dni" placeholder="DNI / Cédula">
            <input id="new_patient_name" placeholder="Nombre Completo">
            <input id="new_patient_email" placeholder="Correo electrónico">
            <input id="new_patient_password" type="password" placeholder="Contraseña Temporal">
            <select id="new_patient_doctor">
                <option value="">Sin doctor asignado</option>
            </select>
        </div>
    `;

            openModal("patient", false);
            loadDoctorsForSelect();
        }

        async function loadDoctorsForSelect() {
            try {
                const res = await fetch(`${API}/admin/doctors`);
                const doctors = await res.json();

                const select = document.getElementById("new_patient_doctor");
                if (!select) return;

                doctors.forEach(d => {
                    const option = document.createElement("option");
                    option.value = d.id_doctor;
                    option.textContent = `${d.name} (${d.email})`;
                    select.appendChild(option);
                });

            } catch (err) {
                console.error(err);
                alert("Error cargando doctores");
            }
        }

        let currentType = null;
        let isEditing = false;

        function openModal(type, editing = false) {
            currentType = type;
            isEditing = editing;

            const modal = document.getElementById("modal");
            modal.classList.remove("hidden");
        }

        function closeModal() {
            document.getElementById("modal").classList.add("hidden");
        }

        function modalSave() {
            if (isEditing) {
                submitFormEdit();
            } else {
                submitForm();
            }
        }

        async function submitForm() {
            let payload = {};

            if (currentType === "doctor") {
                payload = {
                    doctor_code: document.getElementById("new_doctor_code").value,
                    name: document.getElementById("new_doctor_name").value,
                    email: document.getElementById("new_doctor_email").value,
                    password: document.getElementById("new_doctor_password").value,
                    id_clinic: document.getElementById("new_doctor_clinic").value || null
                };

                try {
                    const res = await fetch(`${API}/admin/new/doctor`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();

                    if (res.ok) {
                        alert("Doctor creado correctamente!");
                        closeModal();
                        loadAdminDoctors();
                    } else {
                        alert("Error al crear doctor: " + JSON.stringify(data));
                    }
                } catch (err) {
                    console.error(err);
                    alert("Error de conexión con el servidor.");
                }

            } else if (currentType === "patient") {
                payload = {
                    dni: document.getElementById("new_patient_dni").value,
                    name: document.getElementById("new_patient_name").value,
                    email: document.getElementById("new_patient_email").value,
                    password: document.getElementById("new_patient_password").value,
                    id_doctor: document.getElementById("new_patient_doctor").value || null
                };

                try {
                    const res = await fetch(`${API}/admin/new/patient`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();

                    if (res.ok) {
                        alert("Paciente creado correctamente!");
                        closeModal();
                        loadAdminPatients();
                    } else {
                        alert("Error al crear paciente: " + JSON.stringify(data));
                    }
                } catch (err) {
                    console.error(err);
                    alert("Error de conexión con el servidor.");
                }
            }
        }

        async function editDoctor(id_doctor) {
            try {
                const res = await fetch(`${API}/admin/doctor/${id_doctor}`);
                if (!res.ok) throw new Error("Doctor no encontrado");

                const doctor = await res.json();

                document.getElementById("modal-title").innerText = "Edit Doctor";
                document.getElementById("modal-body").innerHTML = `
            <input type="hidden" id="edit_doctor_id" value="${doctor.id_doctor}">
            <div style="margin:20px 100px;">
                <input id="edit_doctor_code" placeholder="Código Doctor" value="${doctor.doctor_code}">
                <input id="edit_doctor_name" placeholder="Nombre Completo" value="${doctor.name}">
                <input id="edit_doctor_email" placeholder="Correo electrónico" value="${doctor.email}">
                <input id="edit_doctor_password" type="password" placeholder="Contraseña Temporal (dejar en blanco para mantener actual)">
                <input id="edit_doctor_clinic" placeholder="ID Clínica (opcional)" value="${doctor.id_clinic || ''}">
            </div>
        `;

                currentType = "doctor";
                isEditing = true;
                openModal("doctor", true);
                scrollToBottom();
            } catch (err) {
                console.error(err);
                alert("Error al obtener datos del doctor");
            }
        }

        async function editPatient(id_patient) {
            try {
                const res = await fetch(`${API}/admin/patient/${id_patient}`);
                if (!res.ok) throw new Error("Paciente no encontrado");

                const patient = await res.json();

                document.getElementById("modal-title").innerText = "Edit Patient";
                document.getElementById("modal-body").innerHTML = `
            <input type="hidden" id="edit_patient_id" value="${patient.id_patient}">
            <div style="margin:20px 100px;">
                <input id="edit_patient_dni" placeholder="DNI / Cédula" value="${patient.dni}">
                <input id="edit_patient_name" placeholder="Nombre Completo" value="${patient.name}">
                <input id="edit_patient_email" placeholder="Correo electrónico" value="${patient.email}">
                <input id="edit_patient_password" type="password" placeholder="Contraseña Temporal (dejar en blanco para mantener actual)">
                <select id="edit_patient_doctor">
                    <option value="">Sin doctor asignado</option>
                </select>
            </div>
        `;

                const doctorRes = await fetch(`${API}/admin/doctors`);
                const doctors = await doctorRes.json();
                const select = document.getElementById("edit_patient_doctor");
                doctors.forEach(d => {
                    const option = document.createElement("option");
                    option.value = d.id_doctor;
                    option.textContent = `${d.name} (${d.email})`;
                    if (d.id_doctor === patient.id_doctor) option.selected = true;
                    select.appendChild(option);
                });

                currentType = "patient";
                isEditing = true;
                openModal("patient", true);
                scrollToBottom();

            } catch (err) {
                console.error(err);
                alert("Error al obtener datos del paciente");
            }
        }

        async function submitFormEdit() {
            let payload = {};
            let endpoint = "";
            let method = "PUT";

            if (currentType === "doctor") {
                const idDoctor = document.getElementById("edit_doctor_id").value;
                if (!idDoctor) return alert("No se encontró el ID del doctor.");

                payload = {
                    name: document.getElementById("edit_doctor_name").value,
                    email: document.getElementById("edit_doctor_email").value,
                    id_clinic: document.getElementById("edit_doctor_clinic").value || null
                };

                const password = document.getElementById("edit_doctor_password").value;
                if (password) payload.password = password;

                endpoint = `${API}/admin/doctor/${idDoctor}`;

            } else if (currentType === "patient") {
                const idPatient = document.getElementById("edit_patient_id").value;
                if (!idPatient) return alert("No se encontró el ID del paciente.");

                payload = {
                    name: document.getElementById("edit_patient_name").value,
                    email: document.getElementById("edit_patient_email").value,
                    dni: document.getElementById("edit_patient_dni").value,
                    id_doctor: document.getElementById("edit_patient_doctor").value || null
                };

                const password = document.getElementById("edit_patient_password").value;
                if (password) payload.password = password;

                endpoint = `${API}/admin/patient/${idPatient}`;
            }

            try {
                const res = await fetch(endpoint, {
                    method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (res.ok) {
                    alert(`${currentType === "doctor" ? "Doctor" : "Paciente"} actualizado correctamente!`);
                    closeModal();
                    loadAdminDoctors();
                    loadAdminPatients();
                } else {
                    alert("Error al actualizar: " + JSON.stringify(data));
                }

            } catch (err) {
                console.error(err);
                alert("Error de conexión con el servidor.");
            }
        }
    </script>

</body>

</html>
