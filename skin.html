<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SkinXpert</title>
<style>
    body { font-family: Arial,sans-serif; background:#f2f2f2; margin:0; padding:0; }
    .container { width:90%; max-width:420px; margin:60px auto; padding:25px; background:white; border-radius:12px; box-shadow:0 0 12px rgba(0,0,0,0.1);}
    h2,h3 { text-align:center; }
    input, button { width:100%; margin-top:12px; padding:12px; border-radius:6px; border:1px solid #ccc; }
    button { background:#2A6BE4; color:white; cursor:pointer; font-weight:bold; }
    button:hover { background:#1f52b4; }
    .hidden { display:none; }
    .case-card { padding:12px; background:#fff; margin-top:10px; border-radius:8px; border:1px solid #ddd; }
    .case-card img { width:100%; border-radius:6px; margin-top:8px; }
</style>
</head>
<body>

<div id="loginPage" class="container">
<h2>Iniciar Sesión</h2>
<input id="email" type="email" placeholder="Correo electrónico">
<input id="password" type="password" placeholder="Contraseña">
<button onclick="login()">Entrar</button>
<div class="nav"><a href="#" onclick="showRegister()">¿No tienes cuenta? Registrarse</a></div>
</div>

<div id="registerPage" class="container hidden">
<h2>Registro</h2>
<input id="reg_name" type="text" placeholder="Nombre completo">
<input id="reg_email" type="email" placeholder="Correo electrónico">
<input id="reg_password" type="password" placeholder="Contraseña">
<button onclick="register()">Crear cuenta</button>
<div class="nav"><a href="#" onclick="showLogin()">Volver al login</a></div>
</div>

<div id="userDashboard" class="container hidden">
<h2>Mis Consultas</h2>
<h3>Crear nueva consulta</h3>
<input type="file" id="uploadImage">
<button onclick="uploadCase()">Enviar imagen</button>
<hr>
<h3>Historial</h3>
<div id="userCases"></div>
<button style="margin-top:25px; background:#888;" onclick="logout()">Cerrar sesión</button>
</div>

<div id="doctorDashboard" class="container hidden">
<h2>Casos pendientes</h2>
<div id="doctorCases"></div>
<button style="margin-top:25px; background:#888;" onclick="logout()">Cerrar sesión</button>
</div>

<script>
const API = "http://localhost:1880";

function showRegister() { loginPage.classList.add("hidden"); registerPage.classList.remove("hidden"); }
function showLogin() { registerPage.classList.add("hidden"); loginPage.classList.remove("hidden"); }
function logout() { localStorage.removeItem("token"); localStorage.removeItem("role"); location.reload(); }

async function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const res = await fetch(`${API}/login`, {
        method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({email,password})
    });
    const data = await res.json();
    if (!res.ok) return alert(data.error||"Error en login");
    localStorage.setItem("token", data.token);
    localStorage.setItem("role", data.user.role);
    loadDashboard();
}

async function register() {
    const name = document.getElementById("reg_name").value;
    const email = document.getElementById("reg_email").value;
    const password = document.getElementById("reg_password").value;
    const res = await fetch(`${API}/register`, {
        method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({name,email,password})
    });
    const data = await res.json();
    if (!res.ok) return alert(data.error||"Error en registro");
    alert("Cuenta creada con éxito");
    showLogin();
}

function loadDashboard() {
    loginPage.classList.add("hidden"); registerPage.classList.add("hidden");
    userDashboard.classList.add("hidden"); doctorDashboard.classList.add("hidden");
    const role = localStorage.getItem("role");
    if(role==="Doctor"){ doctorDashboard.classList.remove("hidden"); loadDoctorCases(); }
    else{ userDashboard.classList.remove("hidden"); loadUserCases(); }
}

async function loadUserCases() {
    const res = await fetch(`${API}/cases`);
    const list = await res.json();
    userCases.innerHTML = "";
    list.forEach(c=>{
        userCases.innerHTML+=`<div class="case-card"><p><b>ID:</b>${c.id_request}</p><p><b>Fecha:</b>${c.created_at}</p><img src="${c.file_path}"></div>`;
    });
}

async function loadDoctorCases() {
    const res = await fetch(`${API}/cases`);
    const list = await res.json();
    doctorCases.innerHTML = "";
    list.forEach(c=>{
        doctorCases.innerHTML+=`<div class="case-card"><p><b>ID:</b>${c.id_request}</p><p><b>Paciente:</b>${c.id_user}</p><img src="${c.file_path}"></div>`;
    });
}

async function uploadCase() {
    const file = document.getElementById("uploadImage").files[0];
    if(!file) return alert("Selecciona una imagen");
    const form = new FormData();
    form.append("image", file);
    await fetch(`${API}/upload`, {method:"POST", body:form});
    alert("Consulta enviada");
    loadUserCases();
}

window.onload=()=>{if(localStorage.getItem("token")) loadDashboard();}
</script>
</body>
</html>
