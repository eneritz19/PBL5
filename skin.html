<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkinXpert</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div id="splash-screen">
        <div class="splash-bouncer-container">
            <img src="logopequeño.png" alt="Cargando..." class="splash-bouncer">
        </div>
    </div>

    <div id="loginPage" class="container reveal-on-scroll" style="max-width: 450px; text-align: center;">
        
        <div style="margin-bottom: 20px;">
            <img src="logopequeño.png" alt="Logo SkinXpert" style="width: 80px; height: auto;">
        </div>
        
        <h2 style="margin-top: 0;">Skin<span class="brand-x">X</span>pert</h2>
        <p style="font-size: 19px; margin-bottom: 30px;">Inicia sesión para continuar.</p>

        <input id="email" type="text" placeholder="Correo electrónico">
        <input id="password" type="password" placeholder="Contraseña">

        <button onclick="handleLogin()">Iniciar Sesión</button>
    </div>


    <div id="patientDashboard" class="container hidden">
        <div class="header-flex">
            <div>
                <h2 style="font-size: 32px;">Hola, <span id="p_name">Paciente</span></h2>
                <span class="role-badge">Paciente</span>
            </div>
            <button class="btn-secondary" style="width: auto; margin:0;" onclick="logout()">Salir</button>
        </div>

        <div class="tabs reveal-on-scroll">
            <button class="tab-btn active" onclick="openTab('p-consult', this)">Consulta</button>
            <button class="tab-btn" onclick="openTab('p-citas', this)">Citas</button>
            <button class="tab-btn" onclick="openTab('p-historial', this)">Historial</button>
        </div>

        <div id="p-consult" class="tab-content active">
            <div class="case-card reveal-on-scroll" style="text-align: center; padding: 50px;">
                <i class="fa-solid fa-camera" style="font-size: 50px; color: #d2d2d7; margin-bottom: 20px;"></i>
                <h3>Nueva Consulta</h3>
                <p>Sube una foto de tu lesión para que tu médico la evalúe.</p>
                <input type="file" id="uploadImage" accept="image/*" capture="environment">
                <button onclick="uploadCase()">Enviar Consulta</button>
            </div>
        </div>

        <div id="p-citas" class="tab-content">
            <div id="patientAppointmentsList"></div>
        </div>

        <div id="p-historial" class="tab-content">
            <div id="patientHistoryList"></div>
        </div>
    </div>


    <div id="doctorDashboard" class="container hidden" style="max-width: 900px;">
        <div class="header-flex">
            <div>
                <h2 style="font-size: 32px;">Dr. <span id="d_name">Médico</span></h2>
                <span class="role-badge">Dermatología</span>
            </div>
            <button class="btn-secondary" style="width: auto; margin:0;" onclick="logout()">Salir</button>
        </div>

        <div class="tabs reveal-on-scroll">
            <button class="tab-btn active" onclick="openTab('d-pending', this)">Pendientes</button>
            <button class="tab-btn" onclick="openTab('d-patients', this)">Pacientes</button>
            <button class="tab-btn" onclick="openTab('d-citas', this)">Agenda</button>
            <button class="tab-btn" onclick="openTab('d-camera', this)">Cámara</button>
        </div>

        <div id="d-pending" class="tab-content active">
            <p class="reveal-on-scroll" style="font-size:14px; color:var(--text-secondary); margin-bottom:20px;">
                <i class="fa-solid fa-arrow-down-short-wide"></i> Ordenado por Urgencia (IA)
            </p>
            <div id="doctorPendingList"></div>
        </div>

        <div id="d-patients" class="tab-content">
            <div id="doctorPatientsList"></div>
        </div>

        <div id="d-citas" class="tab-content">
            <div class="case-card reveal-on-scroll">
                <h3 style="margin-bottom:20px;">Agendar Cita</h3>
                <input type="text" id="appDni" placeholder="DNI del Paciente">
                <input type="datetime-local" id="appDate">
                <button onclick="createAppointment()">Confirmar Cita</button>
            </div>
        </div>

        <div id="d-camera" class="tab-content">
            <div class="case-card reveal-on-scroll" style="background:#000; color:white; text-align:center;">
                <h3 style="color:white; margin-bottom:10px;">Visor Dermatoscopio</h3>
                <video id="camera-preview" autoplay playsinline style="width:100%; border-radius:12px; background:#333; display:none;"></video>
                <div style="padding-top:20px;">
                    <button id="btnCamera" class="btn-secondary" onclick="toggleCamera()" style="background:white !important; color:black !important; width:auto;">
                        <i class="fa-solid fa-camera"></i> Iniciar
                    </button>
                </div>
            </div>
        </div>
    </div>


    <div id="adminDashboard" class="container hidden">
        <div class="header-flex">
            <h2>Admin Panel</h2>
            <button class="btn-secondary" style="width: auto; margin:0;" onclick="logout()">Salir</button>
        </div>
        <div class="case-card reveal-on-scroll">
            <h3>Gestión de Base de Datos</h3>
            <p>Administración de usuarios (Médicos, Pacientes, Clínicas).</p>
            <button onclick="alert('Funcionalidad Admin')">Gestionar Usuarios</button>
        </div>
    </div>


<script>
    const API = "http://localhost:1880";
    let currentUser = null;

    // --- 1. ANIMACIÓN SCROLL ---
    const observerOptions = { root: null, rootMargin: '0px', threshold: 0.1 };
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);

    function initScrollAnimations() {
        const elements = document.querySelectorAll('.case-card, .container, .tabs, .reveal-on-scroll');
        elements.forEach(el => observer.observe(el));
    }

    // --- 2. SPLASH SCREEN (REBOTE) ---
    window.addEventListener('load', () => {
        const splash = document.getElementById('splash-screen');
        setTimeout(() => {
            splash.classList.add('hidden-splash');
            setTimeout(() => {
                splash.style.display = 'none';
                initScrollAnimations();
            }, 800);
        }, 3500); 
    });

    // --- 3. LOGIN ---
    async function handleLogin() {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();

        if (!email || !password) return alert("Por favor, rellena todos los campos.");

        try {
            const res = await fetch(`${API}/login`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, password })
            });

            const data = await res.json();

            if (!data.success) {
                alert("Credenciales incorrectas.");
                return;
            }

            currentUser = data.user; // Guardamos usuario logueado
            document.getElementById("loginPage").classList.add("hidden");

            // ENRUTAMIENTO SEGÚN NUEVA BD (roles)
            if (data.role === "User" || data.role === "patient") { // Ajustado a tu tabla 'patients'
                document.getElementById("patientDashboard").classList.remove("hidden");
                document.getElementById("p_name").innerText = currentUser.name;
                loadPatientData(currentUser.id_patient);
            } 
            else if (data.role === "Doctor" || data.role === "doctor") { // Ajustado a tu tabla 'doctors'
                document.getElementById("doctorDashboard").classList.remove("hidden");
                document.getElementById("d_name").innerText = currentUser.name;
                loadDoctorData(currentUser.id_doctor);
            } 
            else if (data.role === "Admin") {
                document.getElementById("adminDashboard").classList.remove("hidden");
            }
            
            setTimeout(initScrollAnimations, 100);

        } catch (error) {
            console.error(error);
            alert("Error de conexión con el servidor");
        }
    }

    function logout() { location.reload(); }

    // --- 4. INTERFAZ ---
    function openTab(tabId, btn) {
        const parent = btn.closest('.container');
        parent.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        parent.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        parent.querySelector(`#${tabId}`).classList.add('active');
        btn.classList.add('active');
        setTimeout(initScrollAnimations, 50);
    }

    // --- 5. LOGICA PACIENTE ---
    async function loadPatientData(patientId) {
        // Cargar Historial (Simulado con estructura real)
        const historyList = document.getElementById('patientHistoryList');
        // Aquí harías fetch(`${API}/cases?patientId=${patientId}`)
        // Usamos datos mock basados en tus INSERTS de la BD
        const mockHistory = [
            { date: "2025-01-10", status: "diagnosticada", diagnosis: "Acné leve", treatment: "Limpieza diaria + Crema X", img: "https://via.placeholder.com/100" }
        ];

        historyList.innerHTML = mockHistory.map(h => `
            <div class="case-card reveal-on-scroll urgency-low">
                <p style="font-size:14px; color:#888;">${h.date}</p>
                <div style="display:flex; gap:15px; margin-top:10px;">
                    <img src="${h.img}" style="width:80px; height:80px; border-radius:8px; margin:0;">
                    <div>
                        <strong>${h.diagnosis}</strong>
                        <p style="margin-top:5px; font-size:14px;">Tx: ${h.treatment}</p>
                    </div>
                </div>
            </div>
        `).join('');

        // Cargar Citas
        const appointmentsList = document.getElementById('patientAppointmentsList');
        appointmentsList.innerHTML = `
            <div class="case-card reveal-on-scroll urgency-medium">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h4 style="margin:0;">Revisión Evolución</h4>
                        <p style="margin:5px 0 0 0; color:var(--text-secondary);">Dr. Asignado</p>
                    </div>
                    <div style="text-align:right;">
                        <span style="font-weight:bold; color:var(--sk-blue-dark);">15 FEB</span><br>
                        <span style="font-size:14px;">10:00 AM</span>
                    </div>
                </div>
            </div>
        `;
    }

    async function uploadCase() {
        const file = document.getElementById("uploadImage").files[0];
        if(!file) return alert("Selecciona una imagen");
        
        // Simulación de subida a tabla 'photo_requests' e 'images'
        alert("Imagen subida. Se ha creado una solicitud pendiente.");
    }

    // --- 6. LOGICA DOCTOR ---
    async function loadDoctorData(doctorId) {
        // Cargar Pacientes
        const patList = document.getElementById('doctorPatientsList');
        patList.innerHTML = `
            <div class="case-card reveal-on-scroll" style="display:flex; justify-content:space-between; align-items:center;">
                <div><strong>Ana Martínez</strong><br><span style="font-size:14px; color:#888;">DNI: 12345678A</span></div>
                <button class="btn-secondary" style="width:auto; margin:0; padding:10px;">Ficha</button>
            </div>
            <div class="case-card reveal-on-scroll" style="display:flex; justify-content:space-between; align-items:center;">
                <div><strong>Pedro López</strong><br><span style="font-size:14px; color:#888;">DNI: 87654321B</span></div>
                <button class="btn-secondary" style="width:auto; margin:0; padding:10px;">Ficha</button>
            </div>
        `;

        // Cargar Pendientes (Mock basado en 'photo_requests')
        const pendingList = document.getElementById('doctorPendingList');
        const cases = [
            { patient: "Ana Martínez", urgency: 3, img: "https://via.placeholder.com/300/FFEBEB/FF0000?text=Urgencia+3", prediction: "Posible Melanoma" }, // Urgency 3 = Alta
            { patient: "Pedro López", urgency: 1, img: "https://via.placeholder.com/300/F0FFF4/000000?text=Urgencia+1", prediction: "Acné" }      // Urgency 1 = Baja
        ];
        
        // Ordenar por urgencia DESC (3 > 2 > 1)
        cases.sort((a,b) => b.urgency - a.urgency);

        pendingList.innerHTML = cases.map(c => {
            let badgeClass = 'badge-low';
            let cardClass = 'urgency-low';
            let urgencyText = "BAJA";

            if(c.urgency === 3) { badgeClass = 'badge-high'; cardClass = 'urgency-high'; urgencyText = "ALTA (3)"; }
            else if(c.urgency === 2) { badgeClass = 'badge-medium'; cardClass = 'urgency-medium'; urgencyText = "MEDIA (2)"; }

            return `
                <div class="case-card reveal-on-scroll ${cardClass}">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>${c.patient}</h3>
                        <span class="urgency-badge ${badgeClass}">URGENCIA ${urgencyText}</span>
                    </div>
                    <img src="${c.img}" style="height:120px;">
                    <p style="margin-top:15px; color:#1d1d1f;"><b>IA Sugiere:</b> ${c.prediction}</p>
                    
                    <textarea placeholder="Escribe diagnóstico y tratamiento..." rows="3"></textarea>
                    
                    <button style="margin-top:10px;">Guardar Diagnóstico</button>
                </div>
            `;
        }).join('');
    }

    async function createAppointment() {
        const dni = document.getElementById('appDni').value;
        const date = document.getElementById('appDate').value;
        if(!dni || !date) return alert("Rellena todos los campos");
        
        // Simular insert en tabla 'appointments'
        alert(`Cita creada para el paciente con DNI ${dni} el ${date}`);
    }

    // --- CÁMARA ---
    let stream = null;
    async function toggleCamera() {
        const video = document.getElementById('camera-preview');
        const btn = document.getElementById('btnCamera');

        if(video.style.display === 'none') {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.style.display = 'block';
                btn.innerText = "Detener";
                btn.style.color = "red";
            } catch(e) { alert("Cámara no disponible"); }
        } else {
            if(stream) stream.getTracks().forEach(t => t.stop());
            video.style.display = 'none';
            btn.innerText = "Iniciar";
            btn.style.color = "black";
        }
    }
</script>

</body>
</html>