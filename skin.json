[
    {
        "id": "f6f2187d.f17ca8",
        "type": "tab",
        "label": "Flow 1",
        "disabled": false,
        "info": ""
    },
    {
        "id": "9c12c0e15685ca58",
        "type": "MySQLdatabase",
        "name": "skinxpert_mysql",
        "host": "db",
        "port": "3306",
        "db": "skinXpert",
        "tz": "+01:00",
        "charset": "UTF8"
    },
    {
        "id": "f6c96ef87a48cd3f",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-node-mysql": "2.0.0"
        }
    },
    {
        "id": "3cc11d24.ff01a2",
        "type": "comment",
        "z": "f6f2187d.f17ca8",
        "name": "LOGIN - Para la base de datos ",
        "info": "",
        "x": 190,
        "y": 140,
        "wires": []
    },
    {
        "id": "b8a0ead1637ea4b7",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/doctor/patients",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 420,
        "wires": [
            [
                "4b9af06fe6d2871a"
            ]
        ]
    },
    {
        "id": "4b9af06fe6d2871a",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "function 1",
        "func": "msg.topic = `\nSELECT id_patient, name, email, dni \nFROM patients \nWHERE id_doctor = ?\n`;\nmsg.payload = [msg.req.query.id_doctor];\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 420,
        "wires": [
            [
                "60487c38eaaeda68"
            ]
        ]
    },
    {
        "id": "60487c38eaaeda68",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "",
        "x": 560,
        "y": 420,
        "wires": [
            [
                "6bf71425ed6fc4d1"
            ]
        ]
    },
    {
        "id": "6bf71425ed6fc4d1",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 750,
        "y": 420,
        "wires": []
    },
    {
        "id": "980e17674fcde667",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/doctor/pending",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 560,
        "wires": [
            [
                "d8e4286ca87f6aa0"
            ]
        ]
    },
    {
        "id": "d8e4286ca87f6aa0",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "function 2",
        "func": "msg.topic = `\nSELECT \n    pr.id_request,\n    pr.urgency,\n    p.name,\n    p.id_patient,\n    i.file_path\nFROM photo_requests pr\nJOIN patients p ON pr.id_patient = p.id_patient\nLEFT JOIN images i ON pr.id_request = i.id_request\nWHERE p.id_doctor = ?\nAND pr.status != 'diagnosticada'\nORDER BY pr.urgency DESC\n`;\n\nmsg.payload = [msg.req.query.id_doctor];\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 560,
        "wires": [
            [
                "843a7ca03e63f3f1"
            ]
        ]
    },
    {
        "id": "843a7ca03e63f3f1",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "",
        "x": 580,
        "y": 560,
        "wires": [
            [
                "207665b27bf8a7f8"
            ]
        ]
    },
    {
        "id": "207665b27bf8a7f8",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 750,
        "y": 560,
        "wires": []
    },
    {
        "id": "d87e923c38b0e254",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/doctor/appointments",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 680,
        "wires": [
            [
                "9fc204c65907d22e"
            ]
        ]
    },
    {
        "id": "9fc204c65907d22e",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "function 5",
        "func": "msg.topic = `\nSELECT \n    a.id_appointment,\n    a.date,\n    a.status,\n    p.name AS patient_name\nFROM appointments a\nJOIN patients p ON a.id_patient = p.id_patient\nWHERE a.id_doctor = ?\nORDER BY a.date ASC\n`;\n\nmsg.payload = [msg.req.query.id_doctor];\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 680,
        "wires": [
            [
                "dfa6782946514963"
            ]
        ]
    },
    {
        "id": "dfa6782946514963",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "",
        "x": 640,
        "y": 680,
        "wires": [
            [
                "ff57e9ef8709d623"
            ]
        ]
    },
    {
        "id": "ff57e9ef8709d623",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 830,
        "y": 680,
        "wires": []
    },
    {
        "id": "5631dba213510e33",
        "type": "comment",
        "z": "f6f2187d.f17ca8",
        "name": "DOCTORS - base de datos",
        "info": "",
        "x": 170,
        "y": 340,
        "wires": []
    },
    {
        "id": "042a781ea857a9cc",
        "type": "comment",
        "z": "f6f2187d.f17ca8",
        "name": "PACIENTS - base de datos",
        "info": "",
        "x": 170,
        "y": 780,
        "wires": []
    },
    {
        "id": "7bb9ad204c72d6c8",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/patient/history",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 860,
        "wires": [
            [
                "fefb969c68584b8d"
            ]
        ]
    },
    {
        "id": "fefb969c68584b8d",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "function 6",
        "func": "msg.topic = `\nSELECT \n    d.diagnosis_date,\n    sd.disease,\n    d.doctor_notes,\n    i.file_path\nFROM diagnoses d\nJOIN skin_diseases sd ON d.id_skindiseases = sd.id_skindiseases\nLEFT JOIN photo_requests pr ON d.id_request = pr.id_request\nLEFT JOIN images i ON pr.id_request = i.id_request\nWHERE d.id_patient = ?\nORDER BY d.diagnosis_date DESC\n`;\nmsg.payload = [msg.req.query.id_patient];\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 860,
        "wires": [
            [
                "06d628376f115224"
            ]
        ]
    },
    {
        "id": "06d628376f115224",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "",
        "x": 620,
        "y": 860,
        "wires": [
            [
                "d110b010bc68b2cc"
            ]
        ]
    },
    {
        "id": "d110b010bc68b2cc",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 810,
        "y": 860,
        "wires": []
    },
    {
        "id": "e59ed9ea10b6f55c",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/patient/appointments",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 980,
        "wires": [
            [
                "0024f9ae07951d53"
            ]
        ]
    },
    {
        "id": "0024f9ae07951d53",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "function 7",
        "func": "msg.topic = `\nSELECT \n    a.date,\n    a.status,\n    d.name AS doctor_name\nFROM appointments a\nJOIN doctors d ON a.id_doctor = d.id_doctor\nWHERE a.id_patient = ?\nORDER BY a.date DESC\n`;\nmsg.payload = [msg.req.query.id_patient];\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 980,
        "wires": [
            [
                "e0204d8eede6034d"
            ]
        ]
    },
    {
        "id": "e0204d8eede6034d",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "",
        "x": 680,
        "y": 980,
        "wires": [
            [
                "2e54fb88cf5d4c48"
            ]
        ]
    },
    {
        "id": "2e54fb88cf5d4c48",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 910,
        "y": 980,
        "wires": []
    },
    {
        "id": "e6a0c5f2.1b3b38",
        "type": "comment",
        "z": "f6f2187d.f17ca8",
        "name": "NUEVO: DOCTOR - ENVIAR INFORME",
        "info": "",
        "x": 200,
        "y": 1360,
        "wires": []
    },
    {
        "id": "http_in_report",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/doctor/send_report",
        "method": "post",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 230,
        "y": 1820,
        "wires": [
            [
                "debug_raw_input",
                "func_prepare_simple"
            ]
        ]
    },
    {
        "id": "debug_raw_input",
        "type": "debug",
        "z": "f6f2187d.f17ca8",
        "name": "1. LLEGA ESTO",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 480,
        "y": 1760,
        "wires": []
    },
    {
        "id": "func_prepare_simple",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "Preparar SQL (Forzado)",
        "func": "const d = msg.payload;\n\n// 1. Extraer datos con valores por defecto para seguridad\nconst id_req = d.id_request || d.requestId || 0;\nconst id_doc = d.id_doctor || d.doctorId || 1;\nconst id_pat = d.id_patient || d.patientId || 1;\nconst id_dis = d.id_skindiseases || 1;\nconst conf = d.confidence || 100;\nconst notes = d.doctor_notes || d.notes || \"Diagnostico guardado\";\n// Esto quita la 'T' del formato HTML y asegura que MySQL lo lea como texto plano sin zonas horarias\nconst app_date = d.appointment_date ? d.appointment_date.substring(0, 16).replace('T', ' ') : null;\n\n// 2. Mensaje para el Puerto 1 (Tabla diagnoses)\nconst msgDiagnosis = {\n    ...msg,\n    topic: `INSERT INTO diagnoses \n            (id_request, id_doctor, id_patient, id_skindiseases, confidence, doctor_notes) \n            VALUES (?, ?, ?, ?, ?, ?)`,\n    payload: [id_req, id_doc, id_pat, id_dis, conf, notes],\n    request_id: id_req // Para el siguiente nodo Update Status\n};\n\n// 3. Mensaje para el Puerto 2 (Tabla appointments)\nlet msgAppointment = null;\nif (app_date && app_date !== \"\") {\n    msgAppointment = {\n        topic: `INSERT INTO appointments (id_patient, id_doctor, date, status, comments) \n                VALUES (?, ?, ?, 'pendiente', ?)`,\n        payload: [id_pat, id_doc, app_date, \"Cita programada tras informe médico\"]\n    };\n}\n\n// 4. Retornar los dos mensajes por sus respectivos puertos\nreturn [msgDiagnosis, msgAppointment];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 1820,
        "wires": [
            [
                "mysql_insert_diag"
            ],
            [
                "2201348d70eabd60"
            ]
        ]
    },
    {
        "id": "mysql_insert_diag",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "Guardar Diagnosis",
        "x": 770,
        "y": 1820,
        "wires": [
            [
                "func_update_req_simple",
                "debug_success"
            ]
        ]
    },
    {
        "id": "debug_success",
        "type": "debug",
        "z": "f6f2187d.f17ca8",
        "name": "2. GUARDADO OK",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 990,
        "y": 1760,
        "wires": []
    },
    {
        "id": "func_update_req_simple",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "Update Request",
        "func": "msg.topic = \"UPDATE photo_requests SET status = 'diagnosticada' WHERE id_request = ?\";\nmsg.payload = [msg.request_id];\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 980,
        "y": 1820,
        "wires": [
            [
                "mysql_update_status"
            ]
        ]
    },
    {
        "id": "mysql_update_status",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "Update Status",
        "x": 1180,
        "y": 1820,
        "wires": [
            [
                "http_response_ok"
            ]
        ]
    },
    {
        "id": "http_response_ok",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "OK",
        "statusCode": "200",
        "headers": {},
        "x": 1350,
        "y": 1820,
        "wires": []
    },
    {
        "id": "catch_errors",
        "type": "catch",
        "z": "f6f2187d.f17ca8",
        "name": "Capturar Errores",
        "scope": null,
        "uncaught": false,
        "x": 1040,
        "y": 1900,
        "wires": [
            [
                "debug_error_critico",
                "http_response_error"
            ]
        ]
    },
    {
        "id": "debug_error_critico",
        "type": "debug",
        "z": "f6f2187d.f17ca8",
        "name": "ERROR",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "error",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1240,
        "y": 1900,
        "wires": []
    },
    {
        "id": "http_response_error",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "Error",
        "statusCode": "500",
        "headers": {},
        "x": 1250,
        "y": 1940,
        "wires": []
    },
    {
        "id": "d3522be994903e31",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/patient/upload_photo",
        "method": "post",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 1460,
        "wires": [
            [
                "d9c93aa684aa0527"
            ]
        ]
    },
    {
        "id": "d9c93aa684aa0527",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "Decodificar y Guardar Foto",
        "func": "// 1. Obtener datos del payload enviado por el HTML\nconst id_patient = msg.payload.id_patient;\nconst urgency = msg.payload.urgency || 50;\nlet base64Image = msg.payload.image_base64;\nconst originalFileName = msg.payload.file_name;\n\n// 2. Definir rutas\nconst UPLOADS_DIR = '/usr/share/nginx/html/uploads/';\nconst extension = originalFileName.split('.').pop();\nconst uniqueFileName = `paciente_${id_patient}_${Date.now()}.${extension}`;\nconst fullPath = UPLOADS_DIR + uniqueFileName;\nconst webPath = `/uploads/${uniqueFileName}`;\n\n// 3. Limpiar Base64\nif (base64Image.startsWith('data:')) {\n    base64Image = base64Image.split(',')[1];\n}\n\n// 4. Guardar imagen\nconst imageBuffer = Buffer.from(base64Image, 'base64');\n\ntry {\n    fs.writeFileSync(fullPath, imageBuffer);\n    node.warn(`Imagen guardada en: ${fullPath}`);\n} catch (e) {\n    msg.statusCode = 500;\n    msg.payload = { success: false, error: \"Error al guardar la imagen\" };\n    return msg;\n}\n\n// 5. Preparar INSERT photo_requests\nmsg.topic = \"INSERT INTO photo_requests (id_patient, urgency, status) VALUES (?, ?, 'pendiente')\";\nmsg.payload = [id_patient, urgency];\n\n// Guardamos la ruta para la siguiente función\nflow.set('temp_image_path', webPath);\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "fs",
                "module": "fs"
            }
        ],
        "x": 520,
        "y": 1460,
        "wires": [
            [
                "d5c2613c2551825f"
            ]
        ]
    },
    {
        "id": "0516b36f2bbd3d1e",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1390,
        "y": 1580,
        "wires": []
    },
    {
        "id": "d5c2613c2551825f",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "photo_requests",
        "x": 840,
        "y": 1460,
        "wires": [
            [
                "352eb9406bb189ea"
            ]
        ]
    },
    {
        "id": "352eb9406bb189ea",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "Preparar Inserción Imagen",
        "func": "const id_request = msg.payload.insertId;\nconst file_path = flow.get('temp_image_path');\n\nif (!id_request || !file_path) {\n    msg.statusCode = 500;\n    msg.payload = { success: false, error: \"Error interno\" };\n    return [null, msg];\n}\n\n// Mensaje para DB\nconst msgImage = {\n    ...msg,\n    topic: \"INSERT INTO images (id_request, file_path) VALUES (?, ?)\",\n    payload: [id_request, file_path]\n};\n\n// Mensaje FINAL para frontend\nconst msgResponse = {\n    ...msg,\n    statusCode: 201,\n    payload: {\n        success: true,\n        message: \"Photo uploaded successfully\",\n        file_path\n    }\n};\n\nreturn [msgImage, msgResponse];\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1100,
        "y": 1460,
        "wires": [
            [
                "16d2d68bcbb42eea"
            ],
            [
                "0516b36f2bbd3d1e"
            ]
        ]
    },
    {
        "id": "16d2d68bcbb42eea",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "DB: Insert images",
        "x": 1390,
        "y": 1460,
        "wires": [
            []
        ]
    },
    {
        "id": "2201348d70eabd60",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "Guardar citas",
        "x": 760,
        "y": 1920,
        "wires": [
            []
        ]
    },
    {
        "id": "53efef56eb1bc4ff",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "GET Admin Doctors",
        "url": "/admin/doctors",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 1160,
        "wires": [
            [
                "c6c69cc9da6728ee"
            ]
        ]
    },
    {
        "id": "c6c69cc9da6728ee",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "Query Doctors",
        "func": "msg.topic = `\nSELECT d.id_doctor, d.doctor_code, d.name, d.email, c.name AS clinic\nFROM doctors d\nLEFT JOIN clinics c ON d.id_clinic = c.id_clinic\n`;\nreturn msg;",
        "outputs": 1,
        "x": 390,
        "y": 1160,
        "wires": [
            [
                "7c0ce728b4fbd786"
            ]
        ]
    },
    {
        "id": "b616b8cca1855feb",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "GET Admin Patients",
        "url": "/admin/patients",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 1240,
        "wires": [
            [
                "72cf2dd091bed0ee"
            ]
        ]
    },
    {
        "id": "72cf2dd091bed0ee",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "Query Patients",
        "func": "msg.topic = `\nSELECT p.id_patient, p.dni, p.name, p.email, d.name AS doctor\nFROM patients p\nLEFT JOIN doctors d ON p.id_doctor = d.id_doctor\n`;\nreturn msg;",
        "outputs": 1,
        "x": 390,
        "y": 1240,
        "wires": [
            [
                "7c0ce728b4fbd786"
            ]
        ]
    },
    {
        "id": "7c0ce728b4fbd786",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "MySQL",
        "x": 650,
        "y": 1200,
        "wires": [
            [
                "aa575a03352c566a"
            ]
        ]
    },
    {
        "id": "aa575a03352c566a",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "Admin Response",
        "statusCode": "",
        "headers": {},
        "x": 910,
        "y": 1200,
        "wires": []
    },
    {
        "id": "f44f5a3b05da6447",
        "type": "comment",
        "z": "f6f2187d.f17ca8",
        "name": "Admin- base de datos",
        "info": "",
        "x": 160,
        "y": 1060,
        "wires": []
    },
    {
        "id": "login_http_in",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "POST /login",
        "url": "/login",
        "method": "post",
        "upload": false,
        "x": 130,
        "y": 240,
        "wires": [
            [
                "login_prepare_query"
            ]
        ]
    },
    {
        "id": "login_prepare_query",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "Preparar Query Login UNION",
        "func": "const { email, password } = msg.payload;\n\nif (!email || !password) {\n    msg.statusCode = 400;\n    msg.payload = { success: false, message: 'Email y password requeridos' };\n    return msg;\n}\n\nmsg.topic = `\nSELECT 'Admin' AS role, id_admin AS id, name, email\nFROM admin\nWHERE email=? AND password=SHA2(?,256)\nUNION\nSELECT 'Patient', id_patient AS id, name, email\nFROM patients\nWHERE email=? AND password=SHA2(?,256)\nUNION\nSELECT 'Doctor', id_doctor AS id, name, email\nFROM doctors\nWHERE email=? AND password=SHA2(?,256)\nLIMIT 1\n`;\n\nmsg.payload = [email, password, email, password, email, password];\nreturn msg;",
        "outputs": 1,
        "x": 380,
        "y": 240,
        "wires": [
            [
                "login_mysql"
            ]
        ]
    },
    {
        "id": "login_mysql",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "MySQL",
        "x": 630,
        "y": 240,
        "wires": [
            [
                "login_process_result"
            ]
        ]
    },
    {
        "id": "login_process_result",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "Procesar resultado login",
        "func": "if (msg.payload.length === 0) {\n    msg.statusCode = 401;\n    msg.payload = { success: false, message: 'Credenciales incorrectas' };\n} else {\n    const user = msg.payload[0];\n    msg.payload = { success: true, role: user.role, user: { id: user.id, name: user.name, email: user.email } };\n    msg.statusCode = 200;\n}\nreturn msg;",
        "outputs": 1,
        "x": 880,
        "y": 240,
        "wires": [
            [
                "login_http_response"
            ]
        ]
    },
    {
        "id": "login_http_response",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "Respuesta Login",
        "statusCode": "",
        "headers": {},
        "x": 1130,
        "y": 240,
        "wires": []
    }
]