[
    {
        "id": "f6f2187d.f17ca8",
        "type": "tab",
        "label": "Flow 1",
        "disabled": false,
        "info": ""
    },
    {
        "id": "3cc11d24.ff01a2",
        "type": "comment",
        "z": "f6f2187d.f17ca8",
        "name": "LOGIN - Para la base de datos ",
        "info": "",
        "x": 190,
        "y": 140,
        "wires": []
    },
    {
        "id": "7ebbad7f8b4750a0",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/analyze_image",
        "method": "post",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 1160,
        "wires": [
            [
                "e31f6c10ea47e53c"
            ]
        ]
    },
    {
        "id": "e31f6c10ea47e53c",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "function 3",
        "func": "// Este nodo confirma que recibimos el Base64 y el token.\nconst base64Image = msg.payload.image_base64;\nconst token = msg.payload.token;\n\nif (!base64Image) {\n    // Si no hay imagen, salta un error y cancela el flujo\n    node.error(\"Error: No se encontr贸 la imagen Base64 en el payload.\");\n    return null;\n}\n\n// 1. **Saltamos la llamada a la IA**\n// 2. Creamos una respuesta SIMULADA, como si la IA hubiera respondido\nmsg.payload = {\n    \"responses\": [\n        {\n            \"labelAnnotations\": [\n                { \"description\": \"Dermatitis\", \"score\": 0.95 },\n                { \"description\": \"Psoriasis\", \"score\": 0.60 },\n                { \"description\": \"Piel sana\", \"score\": 0.05 }\n            ]\n        }\n    ]\n};\n\n// Guardamos datos que podr铆amos necesitar\nmsg.client_token = token;\n\n// Imprimimos una confirmaci贸n de la recepci贸n\nnode.warn(`[SIMULACIN] Imagen Base64 recibida. Longitud: ${base64Image.length} caracteres.`);\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 460,
        "y": 1160,
        "wires": [
            [
                "b67e23f226a00738"
            ]
        ]
    },
    {
        "id": "b67e23f226a00738",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "function 4",
        "func": "// 1. Capturamos la respuesta SIMULADA\nconst ia_response = msg.payload;\n\n// 2. IMPRIMIR los datos COMPLETOs en el Debug de Node-RED (隆Tu requisito cumplido!)\nnode.warn(\"--- Conclusiones de la IA SIMULADAS Recibidas (Debug Output) ---\");\nnode.warn(JSON.stringify(ia_response, null, 2));\n\n// 3. Extracci贸n y formateo para el cliente\nconst labels = ia_response.responses && ia_response.responses[0] && ia_response.responses[0].labelAnnotations;\n\nlet finalSummary = \"No se encontraron conclusiones de la IA.\";\n\nif (labels && labels.length > 0) {\n    finalSummary = labels.map(label => ({\n        description: label.description,\n        score: (label.score * 100).toFixed(2) + '%'\n    }));\n}\n\n// 4. Preparamos el payload final para enviar de vuelta al navegador\nmsg.payload = {\n    success: true,\n    message: \"An谩lisis simulado completado: Se ley贸 la foto correctamente.\",\n    ai_conclusions: finalSummary\n};\n\n// 5. Establecer el c贸digo de estado HTTP 200 (OK)\nmsg.statusCode = 200;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 1160,
        "wires": [
            [
                "6e9806f88e0586c5",
                "86f3f6dc4090804c"
            ]
        ]
    },
    {
        "id": "6e9806f88e0586c5",
        "type": "debug",
        "z": "f6f2187d.f17ca8",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "completeMsgObject",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 940,
        "y": 1260,
        "wires": []
    },
    {
        "id": "86f3f6dc4090804c",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 930,
        "y": 1160,
        "wires": []
    },
    {
        "id": "b8a0ead1637ea4b7",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/doctor/patients",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 420,
        "wires": [
            [
                "4b9af06fe6d2871a"
            ]
        ]
    },
    {
        "id": "4b9af06fe6d2871a",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "function 1",
        "func": "msg.topic = `\nSELECT id_patient, name, email, dni \nFROM patients \nWHERE id_doctor = ?\n`;\nmsg.payload = [msg.req.query.id_doctor];\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 420,
        "wires": [
            [
                "60487c38eaaeda68"
            ]
        ]
    },
    {
        "id": "60487c38eaaeda68",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "",
        "x": 560,
        "y": 420,
        "wires": [
            [
                "6bf71425ed6fc4d1"
            ]
        ]
    },
    {
        "id": "6bf71425ed6fc4d1",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 750,
        "y": 420,
        "wires": []
    },
    {
        "id": "980e17674fcde667",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/doctor/pending",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 560,
        "wires": [
            [
                "d8e4286ca87f6aa0"
            ]
        ]
    },
    {
        "id": "d8e4286ca87f6aa0",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "function 2",
        "func": "msg.topic = `\nSELECT \n    pr.id_request,\n    pr.urgency,\n    p.name,\n    p.id_patient,\n    i.file_path\nFROM photo_requests pr\nJOIN patients p ON pr.id_patient = p.id_patient\nLEFT JOIN images i ON pr.id_request = i.id_request\nWHERE p.id_doctor = ?\nAND pr.status != 'diagnosticada'\nORDER BY pr.urgency DESC\n`;\n\nmsg.payload = [msg.req.query.id_doctor];\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 560,
        "wires": [
            [
                "843a7ca03e63f3f1"
            ]
        ]
    },
    {
        "id": "843a7ca03e63f3f1",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "",
        "x": 580,
        "y": 560,
        "wires": [
            [
                "207665b27bf8a7f8"
            ]
        ]
    },
    {
        "id": "207665b27bf8a7f8",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 750,
        "y": 560,
        "wires": []
    },
    {
        "id": "d87e923c38b0e254",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/doctor/appointments",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 680,
        "wires": [
            [
                "9fc204c65907d22e"
            ]
        ]
    },
    {
        "id": "9fc204c65907d22e",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "function 5",
        "func": "msg.topic = `\nSELECT \n    a.id_appointment,\n    a.date,\n    a.status,\n    p.name AS patient_name\nFROM appointments a\nJOIN patients p ON a.id_patient = p.id_patient\nWHERE a.id_doctor = ?\nORDER BY a.date ASC\n`;\n\nmsg.payload = [msg.req.query.id_doctor];\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 400,
        "y": 680,
        "wires": [
            [
                "dfa6782946514963"
            ]
        ]
    },
    {
        "id": "dfa6782946514963",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "",
        "x": 640,
        "y": 680,
        "wires": [
            [
                "ff57e9ef8709d623"
            ]
        ]
    },
    {
        "id": "ff57e9ef8709d623",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 830,
        "y": 680,
        "wires": []
    },
    {
        "id": "5631dba213510e33",
        "type": "comment",
        "z": "f6f2187d.f17ca8",
        "name": "DOCTORS - base de datos",
        "info": "",
        "x": 170,
        "y": 340,
        "wires": []
    },
    {
        "id": "042a781ea857a9cc",
        "type": "comment",
        "z": "f6f2187d.f17ca8",
        "name": "PACIENTS - base de datos",
        "info": "",
        "x": 170,
        "y": 780,
        "wires": []
    },
    {
        "id": "7bb9ad204c72d6c8",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/patient/history",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 860,
        "wires": [
            [
                "fefb969c68584b8d"
            ]
        ]
    },
    {
        "id": "fefb969c68584b8d",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "function 6",
        "func": "msg.topic = `\nSELECT \n    d.diagnosis_date,\n    sd.disease,\n    d.doctor_notes,\n    i.file_path\nFROM diagnoses d\nJOIN skin_diseases sd ON d.id_skindiseases = sd.id_skindiseases\nLEFT JOIN photo_requests pr ON d.id_request = pr.id_request\nLEFT JOIN images i ON pr.id_request = i.id_request\nWHERE d.id_patient = ?\nORDER BY d.diagnosis_date DESC\n`;\nmsg.payload = [msg.req.query.id_patient];\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 860,
        "wires": [
            [
                "06d628376f115224"
            ]
        ]
    },
    {
        "id": "06d628376f115224",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "",
        "x": 620,
        "y": 860,
        "wires": [
            [
                "d110b010bc68b2cc"
            ]
        ]
    },
    {
        "id": "d110b010bc68b2cc",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 810,
        "y": 860,
        "wires": []
    },
    {
        "id": "e59ed9ea10b6f55c",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/patient/appointments",
        "method": "get",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 980,
        "wires": [
            [
                "0024f9ae07951d53"
            ]
        ]
    },
    {
        "id": "0024f9ae07951d53",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "function 7",
        "func": "msg.topic = `\nSELECT \n    a.date,\n    a.status,\n    d.name AS doctor_name\nFROM appointments a\nJOIN doctors d ON a.id_doctor = d.id_doctor\nWHERE a.id_patient = ?\nORDER BY a.date DESC\n`;\nmsg.payload = [msg.req.query.id_patient];\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 980,
        "wires": [
            [
                "e0204d8eede6034d"
            ]
        ]
    },
    {
        "id": "e0204d8eede6034d",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "",
        "x": 680,
        "y": 980,
        "wires": [
            [
                "2e54fb88cf5d4c48"
            ]
        ]
    },
    {
        "id": "2e54fb88cf5d4c48",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 910,
        "y": 980,
        "wires": []
    },
    {
        "id": "248d04bd4c0be704",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "Login Endpoint",
        "url": "/login",
        "method": "post",
        "swaggerDoc": "",
        "x": 140,
        "y": 200,
        "wires": [
            [
                "7c306ea0a75729e7"
            ]
        ]
    },
    {
        "id": "7c306ea0a75729e7",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "Prepare Login Query",
        "func": "const email = msg.payload?.email?.trim();\nconst password = msg.payload?.password?.trim();\nif (!email || !password) {\n    msg.statusCode = 400;\n    msg.payload = { error: 'Faltan email o password' };\n    return msg;\n}\nmsg.loginEmail = email;\nmsg.loginPassword = password;\nmsg.topic = `SELECT id_patient AS id_user, dni, name, email FROM patients WHERE email='${email}' AND password=SHA2('${password}',256) LIMIT 1`;\nmsg.step = 'check_patient';\nreturn msg;",
        "outputs": 1,
        "x": 380,
        "y": 200,
        "wires": [
            [
                "8d5d8beb19c39255"
            ]
        ]
    },
    {
        "id": "8d5d8beb19c39255",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "Check Patients",
        "x": 630,
        "y": 200,
        "wires": [
            [
                "fedfe4add5101d70"
            ]
        ]
    },
    {
        "id": "22e63ba64c53a651",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "Check Doctors",
        "x": 1130,
        "y": 200,
        "wires": [
            [
                "fedfe4add5101d70"
            ]
        ]
    },
    {
        "id": "fedfe4add5101d70",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "Process Login Result",
        "func": "if (msg.step === 'check_patient') {\n    if (msg.payload.length > 0) {\n        const u = msg.payload[0];\n        msg.payload = { success: true, role: 'Patient', user: { id: u.id_user, dni: u.dni, name: u.name, email: u.email }, token: 'fake-token-patient' };\n        return [msg, null];\n    }\n    msg.step = 'check_doctor';\n    msg.topic = `SELECT id_doctor, doctor_code, name, email, id_clinic FROM doctors WHERE email='${msg.loginEmail}' AND password=SHA2('${msg.loginPassword}',256) LIMIT 1`;\n    return [null, msg];\n}\nif (msg.step === 'check_doctor') {\n    if (msg.payload.length > 0) {\n        const d = msg.payload[0];\n        msg.payload = { success: true, role: 'Doctor', user: { id: d.id_doctor, doctor_code: d.doctor_code, name: d.name, email: d.email, clinic_id: d.id_clinic }, token: 'fake-token-doctor' };\n        return msg;\n    }\n    msg.statusCode = 401;\n    msg.payload = { error: 'Usuario o contrase帽a incorrectos' };\n    return msg;\n}",
        "outputs": 2,
        "x": 880,
        "y": 200,
        "wires": [
            [
                "21758efbae42c621"
            ],
            [
                "22e63ba64c53a651"
            ]
        ]
    },
    {
        "id": "21758efbae42c621",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1130,
        "y": 300,
        "wires": []
    },
    {
        "id": "e6a0c5f2.1b3b38",
        "type": "comment",
        "z": "f6f2187d.f17ca8",
        "name": "NUEVO: DOCTOR - ENVIAR INFORME",
        "info": "",
        "x": 200,
        "y": 1360,
        "wires": []
    },
    {
        "id": "5a50785059eb09d8",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "Upload Photo Endpoint",
        "url": "/patient/upload_photo",
        "method": "post",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 200,
        "y": 1580,
        "wires": [
            [
                "898d0ec7a26f9065"
            ]
        ]
    },
    {
        "id": "898d0ec7a26f9065",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "1. Preparar Solicitud",
        "func": "// Recibimos: id_patient, urgency, image_base64, file_name\nconst { id_patient, urgency, image_base64, file_name } = msg.payload;\n\n// Validaci贸n\nif (!id_patient || !image_base64) {\n    msg.statusCode = 400;\n    msg.payload = { error: 'Faltan datos obligatorios (paciente o foto)' };\n    return [null, msg]; // Salida 2 es error\n}\n\n// Limpiamos el Base64 por si viene con cabecera (data:image/jpeg;base64,...)\nlet cleanBase64 = image_base64;\nif (cleanBase64.includes(\"base64,\")) {\n    cleanBase64 = cleanBase64.split(\"base64,\")[1];\n}\n\n// Guardamos los datos de la imagen en msg.temp para usarlos DESPUS de insertar la solicitud\nmsg.temp = {\n    cleanBase64: cleanBase64,\n    file_name: file_name || 'sin_nombre.jpg'\n};\n\n// Paso 1: Insertar en photo_requests\nmsg.topic = \"INSERT INTO photo_requests (id_patient, urgency, status) VALUES (?, ?, 'pendiente')\";\nmsg.payload = [id_patient, urgency || 1];\n\nreturn [msg, null];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 460,
        "y": 1580,
        "wires": [
            [
                "9486beedcaa45873"
            ],
            [
                "cdbaa77c3c1008bf"
            ]
        ]
    },
    {
        "id": "9486beedcaa45873",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "DB: Crear Request",
        "x": 710,
        "y": 1580,
        "wires": [
            [
                "b9d645372e37eac3"
            ]
        ]
    },
    {
        "id": "b9d645372e37eac3",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "2. Preparar Imagen",
        "func": "// Recuperamos el ID de la solicitud que acabamos de crear\nconst id_request = msg.payload.insertId;\n\n// Recuperamos la imagen limpia que guardamos en msg.temp\nconst { cleanBase64, file_name } = msg.temp;\n\nif (!id_request) {\n    node.error(\"No se gener贸 ID de solicitud\");\n    throw new Error(\"Error al insertar solicitud\");\n}\n\n// Paso 2: Insertar la imagen vinculada a esa solicitud\n// Usamos la columna 'image_data' que a帽adimos a la base de datos\nmsg.topic = \"INSERT INTO images (id_request, image_data, file_path, file_name) VALUES (?, ?, ?, ?)\";\n\n// Nota: Guardamos image_data (el contenido) y file_path (una ruta ficticia o vac铆a por compatibilidad)\nconst dummyPath = '/uploads/' + file_name;\n\nmsg.payload = [\n    id_request, \n    cleanBase64, // Guardamos el string base64 directo (tipo LONGTEXT)\n    dummyPath,\n    file_name\n];\n\n// Preparamos el mensaje de 茅xito final\nmsg.finalResponse = {\n    success: true,\n    message: 'Foto subida correctamente',\n    request_id: id_request\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 950,
        "y": 1580,
        "wires": [
            [
                "673ead412a4c1ec1"
            ]
        ]
    },
    {
        "id": "673ead412a4c1ec1",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "DB: Guardar Imagen",
        "x": 1200,
        "y": 1580,
        "wires": [
            [
                "ae786ce879188fb4"
            ]
        ]
    },
    {
        "id": "ae786ce879188fb4",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "Respuesta OK",
        "func": "msg.payload = msg.finalResponse;\nmsg.statusCode = 200;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1420,
        "y": 1580,
        "wires": [
            [
                "cdbaa77c3c1008bf"
            ]
        ]
    },
    {
        "id": "cdbaa77c3c1008bf",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "Respuesta HTTP",
        "statusCode": "",
        "headers": {},
        "x": 1650,
        "y": 1580,
        "wires": []
    },
    {
        "id": "http_in_report",
        "type": "http in",
        "z": "f6f2187d.f17ca8",
        "name": "",
        "url": "/doctor/send_report",
        "method": "post",
        "upload": false,
        "skipBodyParsing": false,
        "swaggerDoc": "",
        "x": 230,
        "y": 1820,
        "wires": [
            [
                "debug_raw_input",
                "func_prepare_simple"
            ]
        ]
    },
    {
        "id": "debug_raw_input",
        "type": "debug",
        "z": "f6f2187d.f17ca8",
        "name": "1. LLEGA ESTO",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 480,
        "y": 1760,
        "wires": []
    },
    {
        "id": "func_prepare_simple",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "Preparar SQL (Forzado)",
        "func": "const d = msg.payload;\n\n// Valores por defecto para que NO FALLE si falta algo\n// Si no viene id_skindiseases, ponemos 1. \n// Si no viene confidence, ponemos 100.\nconst id_req = d.id_request || d.requestId || 0;\nconst id_doc = d.id_doctor || d.doctorId || 1;\nconst id_pat = d.id_patient || d.patientId || 1;\nconst id_dis = d.id_skindiseases || 1; // <--- OJO AQU\nconst conf = d.confidence || 100;\nconst notes = d.doctor_notes || d.notes || \"Diagnostico guardado\";\n\nnode.warn(\"Intentando guardar: \" + JSON.stringify({id_req, id_doc, id_pat, id_dis}));\n\nmsg.topic = `INSERT INTO diagnoses \n(id_request, id_doctor, id_patient, id_skindiseases, confidence, doctor_notes) \nVALUES (?, ?, ?, ?, ?, ?)`;\n\nmsg.payload = [id_req, id_doc, id_pat, id_dis, conf, notes];\n\n// Guardamos ID para actualizar estado luego\nmsg.request_id = id_req;\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 510,
        "y": 1820,
        "wires": [
            [
                "mysql_insert_diag"
            ]
        ]
    },
    {
        "id": "mysql_insert_diag",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "Guardar Diagnosis",
        "x": 770,
        "y": 1820,
        "wires": [
            [
                "func_update_req_simple",
                "debug_success"
            ]
        ]
    },
    {
        "id": "debug_success",
        "type": "debug",
        "z": "f6f2187d.f17ca8",
        "name": "2. GUARDADO OK",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 990,
        "y": 1760,
        "wires": []
    },
    {
        "id": "func_update_req_simple",
        "type": "function",
        "z": "f6f2187d.f17ca8",
        "name": "Update Request",
        "func": "msg.topic = \"UPDATE photo_requests SET status = 'diagnosticada' WHERE id_request = ?\";\nmsg.payload = [msg.request_id];\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 980,
        "y": 1820,
        "wires": [
            [
                "mysql_update_status"
            ]
        ]
    },
    {
        "id": "mysql_update_status",
        "type": "mysql",
        "z": "f6f2187d.f17ca8",
        "mydb": "9c12c0e15685ca58",
        "name": "Update Status",
        "x": 1180,
        "y": 1820,
        "wires": [
            [
                "http_response_ok"
            ]
        ]
    },
    {
        "id": "http_response_ok",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "OK",
        "statusCode": "200",
        "headers": {},
        "x": 1350,
        "y": 1820,
        "wires": []
    },
    {
        "id": "catch_errors",
        "type": "catch",
        "z": "f6f2187d.f17ca8",
        "name": "Capturar Errores",
        "scope": null,
        "uncaught": false,
        "x": 760,
        "y": 1900,
        "wires": [
            [
                "debug_error_critico",
                "http_response_error"
            ]
        ]
    },
    {
        "id": "debug_error_critico",
        "type": "debug",
        "z": "f6f2187d.f17ca8",
        "name": " ERROR",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "error",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 970,
        "y": 1900,
        "wires": []
    },
    {
        "id": "http_response_error",
        "type": "http response",
        "z": "f6f2187d.f17ca8",
        "name": "Error",
        "statusCode": "500",
        "headers": {},
        "x": 970,
        "y": 1940,
        "wires": []
    },
    {
        "id": "9c12c0e15685ca58",
        "type": "MySQLdatabase",
        "name": "skinxpert_mysql",
        "host": "db",
        "port": "3306",
        "db": "skinXpert",
        "tz": "",
        "charset": "UTF8"
    },
    {
        "id": "d1ac9423e989b1eb",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-node-mysql": "2.0.0"
        }
    }
]